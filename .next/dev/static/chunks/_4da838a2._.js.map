{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/a./mato1/lib/supabaseClient.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nexport const supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n);\n"],"names":[],"mappings":";;;;AAGE;AAHF;;AAEO,MAAM,WAAW,IAAA,iMAAY"}},
    {"offset": {"line": 19, "column": 0}, "map": {"version":3,"sources":["file:///Users/a./mato1/lib/db.ts"],"sourcesContent":["// lib/db.ts\nimport { supabase } from \"@/lib/supabaseClient\";\n\n/* =========================\n   Helpers\n========================= */\n\nexport function safeImg(src: any) {\n  const s = String(src ?? \"\").trim();\n  if (!s) return \"/example.png\";\n  if (s.startsWith(\"/\")) return s;\n  if (s.startsWith(\"http://\") || s.startsWith(\"https://\")) return s;\n  return \"/example.png\";\n}\n\n/* =========================\n   Types\n========================= */\n\ntype CategoryRow = {\n  id: number;\n  slug: string;\n  img: string | null;\n  name_so: string;\n  name_en: string;\n};\n\ntype SubcategoryRow = {\n  id: number;\n  category_id: number;\n  slug: string;\n  img: string | null;\n  name_so: string;\n  name_en: string;\n};\n\nexport type ProductRow = {\n  id: number;\n  name: string;\n  slug: string;\n  base_price: number; // numeric NOT NULL in DB\n  long_description: string; // NOT NULL in DB\n  category_id: number;\n  subcategory_id: number;\n  brand_id: number;\n  is_discounted: boolean;\n  tags?: string[] | null;\n  is_active: boolean;\n};\nexport type VariantRow = {\n  id: number;\n  product_id: number;\n  label: string;\n  price: number;\n\n  // optional if you track stock\n  stock?: number | null;\n};\n\n/* =========================\n   Home (categories + subcats)\n========================= */\n\nexport async function getCategoriesWithSubcategories() {\n  const { data: cats, error: catErr } = await supabase\n    .from(\"categories\")\n    .select(\"id,slug,img,name_so,name_en\")\n    .order(\"id\", { ascending: true });\n\n  if (catErr) throw catErr;\n\n  const { data: subs, error: subErr } = await supabase\n    .from(\"subcategories\")\n    .select(\"id,category_id,slug,img,name_so,name_en\")\n    .order(\"id\", { ascending: true });\n\n  if (subErr) throw subErr;\n\n  const categories = (cats ?? []) as CategoryRow[];\n  const subcategories = (subs ?? []) as SubcategoryRow[];\n\n  return categories.map((cat) => ({\n    ...cat,\n    subcats: subcategories.filter((s) => s.category_id === cat.id),\n  }));\n}\n\n/* =========================\n   Search page: fetch everything\n========================= */\n\nexport async function fetchAllCategories() {\n  const { data, error } = await supabase.from(\"categories\").select(\"*\").order(\"id\");\n  if (error) throw error;\n  return data ?? [];\n}\n\nexport async function fetchAllSubcategories() {\n  const { data, error } = await supabase.from(\"subcategories\").select(\"*\").order(\"id\");\n  if (error) throw error;\n  return data ?? [];\n}\n\nexport async function fetchAllProducts() {\n  const { data, error } = await supabase.from(\"products\").select(\"*\").order(\"id\");\n  if (error) throw error;\n  return data ?? [];\n}\n\nexport async function fetchAllProductVariants() {\n  const { data, error } = await supabase.from(\"product_variants\").select(\"*\").order(\"id\");\n  if (error) throw error;\n  return data ?? [];\n}\n\nexport async function fetchAllProductImages() {\n  const { data, error } = await supabase\n    .from(\"product_images\")\n    .select(\"*\")\n    .order(\"is_primary\", { ascending: false });\n  if (error) throw error;\n  return data ?? [];\n}\n\n/* =========================\n   Subcategory page helpers\n========================= */\n\nexport async function fetchSubcategoryBySlug(slug: string) {\n  const { data, error } = await supabase\n    .from(\"subcategories\")\n    .select(\"*\")\n    .eq(\"slug\", slug)\n    .maybeSingle();\n\n  if (error) {\n    console.error(\"fetchSubcategoryBySlug error:\", { slug, error });\n    throw error;\n  }\n\n  return data;\n}\nexport async function fetchBrandsByIds(ids: number[]) {\n  try {\n    const clean = Array.from(\n      new Set((ids || []).map((x) => Number(x)).filter((n) => Number.isFinite(n)))\n    );\n    if (!clean.length) return [];\n\n    const { data, error } = await supabase\n      .from(\"brands\")\n      .select(\"id,name,slug\")\n      .in(\"id\", clean)\n      .order(\"name\", { ascending: true });\n\n    if (error) {\n      console.error(\"fetchBrandsByIds error\", error);\n      return [];\n    }\n\n    return data ?? [];\n  } catch (e) {\n    console.error(\"fetchBrandsByIds exception\", e);\n    return [];\n  }\n}\n\nexport async function fetchProductBySlug(slug: string) {\n  const { data, error } = await supabase\n    .from(\"products\")\n    .select(\"*\")\n    .eq(\"slug\", slug)\n    .maybeSingle(); // âœ… doesn't throw when 0 rows\n\n  if (error) {\n    console.error(\"fetchProductBySlug error:\", { slug, error });\n    throw error; // âœ… stop masking real errors as 404\n  }\n\n  return data as ProductRow | null;\n}\n\nexport async function fetchProductsBySubcategoryId(subcategoryId: number) {\n  const { data, error } = await supabase\n    .from(\"products\")\n    .select(\"*\")\n    .eq(\"subcategory_id\", subcategoryId)\n    .order(\"id\", { ascending: true });\n\n  if (error) throw error;\n  return data ?? [];\n}\n\n/**\n * If you don't have subsubcategories yet, you can keep this returning []\n * OR create the table and remove the try/catch.\n */\nexport async function fetchSubSubcategoriesBySubcategoryId(subcategoryId: number) {\n  const { data, error } = await supabase\n    .from(\"subsubcategories\")\n    .select(\"*\")\n    .eq(\"subcategory_id\", subcategoryId)\n    .order(\"id\", { ascending: true });\n\n  // If the table doesn't exist yet, you can return [] instead of throwing.\n  if (error) {\n    // Uncomment next line if you prefer hard-fail:\n    // throw error;\n    return [];\n  }\n  return data ?? [];\n}\n\n/* =========================\n   Product page helpers\n========================= */\n\n\nexport async function fetchSubcategoryById(id: number) {\n  const { data, error } = await supabase.from(\"subcategories\").select(\"*\").eq(\"id\", id).single();\n  if (error) return null;\n  return data;\n}\n\n/**\n * IMPORTANT: object signature (fixes your 22P02 crash).\n */\nexport async function fetchRelatedProducts(args: {\n  subcategoryId: number;\n  excludeProductId: number;\n  limit?: number;\n}) {\n  const limit = args.limit ?? 12;\n\n  const { data, error } = await supabase\n    .from(\"products\")\n    .select(\"*\")\n    .eq(\"subcategory_id\", args.subcategoryId)\n    .neq(\"id\", args.excludeProductId)\n    .limit(limit);\n\n  if (error) throw error;\n  return data ?? [];\n}\n  \n/* =========================\n   Products / Variants / Images: by ids\n========================= */\n\nexport async function getProductsByIds(ids: number[]) {\n  const unique = Array.from(new Set(ids)).filter(Boolean);\n  if (unique.length === 0) return [];\n\n  const { data, error } = await supabase\n    .from(\"products\")\n.select(\n  \"id,name,slug,long_description,category_id,subcategory_id,brand_id,is_discounted,base_price,tags,is_active\"\n).in(\"id\", unique);\n\n  if (error) throw error;\n  return (data ?? []) as ProductRow[];\n}\n\nexport async function getVariantsByIds(ids: number[]) {\n  const unique = Array.from(new Set(ids)).filter((x) => x != null) as number[];\n  if (unique.length === 0) return [];\n\n  const { data, error } = await supabase\n    .from(\"product_variants\")\n    .select(\"id,product_id,label,price,stock\")\n    .in(\"id\", unique);\n\n  if (error) throw error;\n  return (data ?? []) as VariantRow[];\n}\n\nexport async function fetchProductsByIds(ids: number[]) {\n  // alias used by some pages\n  return getProductsByIds(ids);\n}\n\nexport async function fetchVariantsByProductIds(productIds: number[]) {\n  const unique = Array.from(new Set(productIds)).filter(Boolean);\n  if (unique.length === 0) return [];\n\n  const { data, error } = await supabase\n    .from(\"product_variants\")\n    .select(\"*\")\n    .in(\"product_id\", unique)\n    .order(\"price\", { ascending: true });\n\n  if (error) throw error;\n  return data ?? [];\n}\n\nexport async function fetchImagesByProductIds(productIds: number[]) {\n  const unique = Array.from(new Set(productIds)).filter(Boolean);\n  if (unique.length === 0) return [];\n\n  const { data, error } = await supabase\n    .from(\"product_images\")\n    .select(\"*\")\n    .in(\"product_id\", unique)\n    .order(\"is_primary\", { ascending: false });\n\n  if (error) throw error;\n  return data ?? [];\n}\n\n/* =========================\n   Single-ID wrappers (your product page imports these)\n========================= */\n\nexport async function fetchVariantsByProductId(productId: number) {\n  return fetchVariantsByProductIds([productId]);\n}\n\nexport async function fetchImagesByProductId(productId: number) {\n  return fetchImagesByProductIds([productId]);\n}\n\n/* =========================\n   Co-purchase (recommendations)\n========================= */\n\nexport async function fetchBoughtTogetherProductIds(args: {\n  productId: number;\n  limit?: number;\n  excludeIds?: number[];\n}) {\n  const limit = args.limit ?? 12;\n  const exclude = new Set([args.productId, ...(args.excludeIds ?? [])]);\n\n  const { data, error } = await supabase\n    .from(\"copurchase_counts\")\n    .select(\"co_product_id,count\")\n    .eq(\"product_id\", args.productId)\n    .order(\"count\", { ascending: false })\n    .limit(limit * 3);\n\n  if (error) throw error;\n\n  const ids: number[] = [];\n  for (const row of data ?? []) {\n    const id = Number((row as any).co_product_id);\n    if (!exclude.has(id)) ids.push(id);\n    if (ids.length >= limit) break;\n  }\n  return ids;\n}\n\n/* =========================\n   Customers (optional)\n========================= */\n\nexport async function searchCustomers(query: string) {\n  const q = query.trim();\n  if (!q) return [];\n\n  const { data, error } = await supabase\n    .from(\"customers\")\n    .select(\"id,name,phone\")\n    .or(`name.ilike.%${q}%,phone.ilike.%${q}%`)\n    .limit(8);\n\n  if (error) throw error;\n  return data ?? [];\n}\n\n/* =========================\n   Orders (checkout)\n========================= */\n\nexport async function createOrder(args: {\n  customer_id: number | null;\n  delivery: { name: string; phone: string; address: string; note?: string };\n  total_amount: number;\n}) {\n  const { data, error } = await supabase\n    .from(\"orders\")\n    .insert({\n      customer_id: args.customer_id,\n      delivery_name: args.delivery.name,\n      delivery_phone: args.delivery.phone,\n      delivery_address: args.delivery.address,\n      delivery_note: args.delivery.note ?? null,\n      total_amount: args.total_amount,\n      status: \"PENDING\",\n    })\n    .select(\"id\")\n    .single();\n\n  if (error) throw error;\n  return data as { id: number };\n}\n\nexport async function createOrderItems(\n  orderId: number,\n  items: Array<{\n    productId: number;\n    variantId: number | null;\n    qty: number;\n    priceAtPurchase: number;\n  }>\n) {\n  const payload = items.map((it) => ({\n    order_id: orderId,\n    product_id: it.productId,\n    variant_id: it.variantId,\n    quantity: it.qty,\n    price_at_purchase: it.priceAtPurchase,\n  }));\n\n  const { error } = await supabase.from(\"order_items\").insert(payload);\n\n  if (error) {\n    // helpful debugging\n    console.log(\"ORDER_ITEMS_INSERT_ERROR\", error);\n    throw error;\n  }\n}\n"],"names":[],"mappings":"AAAA,YAAY;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACZ;;AAMO,SAAS,QAAQ,GAAQ;IAC9B,MAAM,IAAI,OAAO,OAAO,IAAI,IAAI;IAChC,IAAI,CAAC,GAAG,OAAO;IACf,IAAI,EAAE,UAAU,CAAC,MAAM,OAAO;IAC9B,IAAI,EAAE,UAAU,CAAC,cAAc,EAAE,UAAU,CAAC,aAAa,OAAO;IAChE,OAAO;AACT;AAkDO,eAAe;IACpB,MAAM,EAAE,MAAM,IAAI,EAAE,OAAO,MAAM,EAAE,GAAG,MAAM,oIAAQ,CACjD,IAAI,CAAC,cACL,MAAM,CAAC,+BACP,KAAK,CAAC,MAAM;QAAE,WAAW;IAAK;IAEjC,IAAI,QAAQ,MAAM;IAElB,MAAM,EAAE,MAAM,IAAI,EAAE,OAAO,MAAM,EAAE,GAAG,MAAM,oIAAQ,CACjD,IAAI,CAAC,iBACL,MAAM,CAAC,2CACP,KAAK,CAAC,MAAM;QAAE,WAAW;IAAK;IAEjC,IAAI,QAAQ,MAAM;IAElB,MAAM,aAAc,QAAQ,EAAE;IAC9B,MAAM,gBAAiB,QAAQ,EAAE;IAEjC,OAAO,WAAW,GAAG,CAAC,CAAC,MAAQ,CAAC;YAC9B,GAAG,GAAG;YACN,SAAS,cAAc,MAAM,CAAC,CAAC,IAAM,EAAE,WAAW,KAAK,IAAI,EAAE;QAC/D,CAAC;AACH;AAMO,eAAe;IACpB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CAAC,IAAI,CAAC,cAAc,MAAM,CAAC,KAAK,KAAK,CAAC;IAC5E,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAEO,eAAe;IACpB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CAAC,IAAI,CAAC,iBAAiB,MAAM,CAAC,KAAK,KAAK,CAAC;IAC/E,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAEO,eAAe;IACpB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CAAC,IAAI,CAAC,YAAY,MAAM,CAAC,KAAK,KAAK,CAAC;IAC1E,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAEO,eAAe;IACpB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CAAC,IAAI,CAAC,oBAAoB,MAAM,CAAC,KAAK,KAAK,CAAC;IAClF,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAEO,eAAe;IACpB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,kBACL,MAAM,CAAC,KACP,KAAK,CAAC,cAAc;QAAE,WAAW;IAAM;IAC1C,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAMO,eAAe,uBAAuB,IAAY;IACvD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,iBACL,MAAM,CAAC,KACP,EAAE,CAAC,QAAQ,MACX,WAAW;IAEd,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,iCAAiC;YAAE;YAAM;QAAM;QAC7D,MAAM;IACR;IAEA,OAAO;AACT;AACO,eAAe,iBAAiB,GAAa;IAClD,IAAI;QACF,MAAM,QAAQ,MAAM,IAAI,CACtB,IAAI,IAAI,CAAC,OAAO,EAAE,EAAE,GAAG,CAAC,CAAC,IAAM,OAAO,IAAI,MAAM,CAAC,CAAC,IAAM,OAAO,QAAQ,CAAC;QAE1E,IAAI,CAAC,MAAM,MAAM,EAAE,OAAO,EAAE;QAE5B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,UACL,MAAM,CAAC,gBACP,EAAE,CAAC,MAAM,OACT,KAAK,CAAC,QAAQ;YAAE,WAAW;QAAK;QAEnC,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,EAAE;QACX;QAEA,OAAO,QAAQ,EAAE;IACnB,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,EAAE;IACX;AACF;AAEO,eAAe,mBAAmB,IAAY;IACnD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,QAAQ,MACX,WAAW,IAAI,8BAA8B;IAEhD,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,6BAA6B;YAAE;YAAM;QAAM;QACzD,MAAM,OAAO,oCAAoC;IACnD;IAEA,OAAO;AACT;AAEO,eAAe,6BAA6B,aAAqB;IACtE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,kBAAkB,eACrB,KAAK,CAAC,MAAM;QAAE,WAAW;IAAK;IAEjC,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAMO,eAAe,qCAAqC,aAAqB;IAC9E,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,oBACL,MAAM,CAAC,KACP,EAAE,CAAC,kBAAkB,eACrB,KAAK,CAAC,MAAM;QAAE,WAAW;IAAK;IAEjC,yEAAyE;IACzE,IAAI,OAAO;QACT,+CAA+C;QAC/C,eAAe;QACf,OAAO,EAAE;IACX;IACA,OAAO,QAAQ,EAAE;AACnB;AAOO,eAAe,qBAAqB,EAAU;IACnD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CAAC,IAAI,CAAC,iBAAiB,MAAM,CAAC,KAAK,EAAE,CAAC,MAAM,IAAI,MAAM;IAC5F,IAAI,OAAO,OAAO;IAClB,OAAO;AACT;AAKO,eAAe,qBAAqB,IAI1C;IACC,MAAM,QAAQ,KAAK,KAAK,IAAI;IAE5B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,kBAAkB,KAAK,aAAa,EACvC,GAAG,CAAC,MAAM,KAAK,gBAAgB,EAC/B,KAAK,CAAC;IAET,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAMO,eAAe,iBAAiB,GAAa;IAClD,MAAM,SAAS,MAAM,IAAI,CAAC,IAAI,IAAI,MAAM,MAAM,CAAC;IAC/C,IAAI,OAAO,MAAM,KAAK,GAAG,OAAO,EAAE;IAElC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,YACT,MAAM,CACL,6GACA,EAAE,CAAC,MAAM;IAET,IAAI,OAAO,MAAM;IACjB,OAAQ,QAAQ,EAAE;AACpB;AAEO,eAAe,iBAAiB,GAAa;IAClD,MAAM,SAAS,MAAM,IAAI,CAAC,IAAI,IAAI,MAAM,MAAM,CAAC,CAAC,IAAM,KAAK;IAC3D,IAAI,OAAO,MAAM,KAAK,GAAG,OAAO,EAAE;IAElC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,oBACL,MAAM,CAAC,mCACP,EAAE,CAAC,MAAM;IAEZ,IAAI,OAAO,MAAM;IACjB,OAAQ,QAAQ,EAAE;AACpB;AAEO,eAAe,mBAAmB,GAAa;IACpD,2BAA2B;IAC3B,OAAO,iBAAiB;AAC1B;AAEO,eAAe,0BAA0B,UAAoB;IAClE,MAAM,SAAS,MAAM,IAAI,CAAC,IAAI,IAAI,aAAa,MAAM,CAAC;IACtD,IAAI,OAAO,MAAM,KAAK,GAAG,OAAO,EAAE;IAElC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,oBACL,MAAM,CAAC,KACP,EAAE,CAAC,cAAc,QACjB,KAAK,CAAC,SAAS;QAAE,WAAW;IAAK;IAEpC,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAEO,eAAe,wBAAwB,UAAoB;IAChE,MAAM,SAAS,MAAM,IAAI,CAAC,IAAI,IAAI,aAAa,MAAM,CAAC;IACtD,IAAI,OAAO,MAAM,KAAK,GAAG,OAAO,EAAE;IAElC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,kBACL,MAAM,CAAC,KACP,EAAE,CAAC,cAAc,QACjB,KAAK,CAAC,cAAc;QAAE,WAAW;IAAM;IAE1C,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAMO,eAAe,yBAAyB,SAAiB;IAC9D,OAAO,0BAA0B;QAAC;KAAU;AAC9C;AAEO,eAAe,uBAAuB,SAAiB;IAC5D,OAAO,wBAAwB;QAAC;KAAU;AAC5C;AAMO,eAAe,8BAA8B,IAInD;IACC,MAAM,QAAQ,KAAK,KAAK,IAAI;IAC5B,MAAM,UAAU,IAAI,IAAI;QAAC,KAAK,SAAS;WAAM,KAAK,UAAU,IAAI,EAAE;KAAE;IAEpE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,qBACL,MAAM,CAAC,uBACP,EAAE,CAAC,cAAc,KAAK,SAAS,EAC/B,KAAK,CAAC,SAAS;QAAE,WAAW;IAAM,GAClC,KAAK,CAAC,QAAQ;IAEjB,IAAI,OAAO,MAAM;IAEjB,MAAM,MAAgB,EAAE;IACxB,KAAK,MAAM,OAAO,QAAQ,EAAE,CAAE;QAC5B,MAAM,KAAK,OAAO,AAAC,IAAY,aAAa;QAC5C,IAAI,CAAC,QAAQ,GAAG,CAAC,KAAK,IAAI,IAAI,CAAC;QAC/B,IAAI,IAAI,MAAM,IAAI,OAAO;IAC3B;IACA,OAAO;AACT;AAMO,eAAe,gBAAgB,KAAa;IACjD,MAAM,IAAI,MAAM,IAAI;IACpB,IAAI,CAAC,GAAG,OAAO,EAAE;IAEjB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,aACL,MAAM,CAAC,iBACP,EAAE,CAAC,CAAC,YAAY,EAAE,EAAE,eAAe,EAAE,EAAE,CAAC,CAAC,EACzC,KAAK,CAAC;IAET,IAAI,OAAO,MAAM;IACjB,OAAO,QAAQ,EAAE;AACnB;AAMO,eAAe,YAAY,IAIjC;IACC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,UACL,MAAM,CAAC;QACN,aAAa,KAAK,WAAW;QAC7B,eAAe,KAAK,QAAQ,CAAC,IAAI;QACjC,gBAAgB,KAAK,QAAQ,CAAC,KAAK;QACnC,kBAAkB,KAAK,QAAQ,CAAC,OAAO;QACvC,eAAe,KAAK,QAAQ,CAAC,IAAI,IAAI;QACrC,cAAc,KAAK,YAAY;QAC/B,QAAQ;IACV,GACC,MAAM,CAAC,MACP,MAAM;IAET,IAAI,OAAO,MAAM;IACjB,OAAO;AACT;AAEO,eAAe,iBACpB,OAAe,EACf,KAKE;IAEF,MAAM,UAAU,MAAM,GAAG,CAAC,CAAC,KAAO,CAAC;YACjC,UAAU;YACV,YAAY,GAAG,SAAS;YACxB,YAAY,GAAG,SAAS;YACxB,UAAU,GAAG,GAAG;YAChB,mBAAmB,GAAG,eAAe;QACvC,CAAC;IAED,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CAAC,IAAI,CAAC,eAAe,MAAM,CAAC;IAE5D,IAAI,OAAO;QACT,oBAAoB;QACpB,QAAQ,GAAG,CAAC,4BAA4B;QACxC,MAAM;IACR;AACF"}},
    {"offset": {"line": 299, "column": 0}, "map": {"version":3,"sources":["file:///Users/a./mato1/app/search/results/%5Btag%5D/page.tsx"],"sourcesContent":["\"use client\";\n\nimport TopNavbar from \"@/components/TopNavBar\";\nimport { useParams } from \"next/navigation\";\nimport Link from \"next/link\";\nimport Image from \"next/image\";\nimport { useEffect, useMemo, useState } from \"react\";\n\nimport {\n  fetchAllProducts,\n  fetchAllProductImages,\n  fetchAllProductVariants,\n  safeImg,\n} from \"@/lib/db\";\n\nexport default function SearchResultsPage() {\n  const { tag } = useParams();\n  const decodedTag = decodeURIComponent(tag as string).trim().toLowerCase();\n\n  const [products, setProducts] = useState<any[]>([]);\n  const [productImages, setProductImages] = useState<any[]>([]);\n  const [productVariants, setProductVariants] = useState<any[]>([]);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    (async () => {\n      try {\n        const [prods, vars, imgs] = await Promise.all([\n          fetchAllProducts(),\n          fetchAllProductVariants(),\n          fetchAllProductImages(),\n        ]);\n        setProducts(prods);\n        setProductVariants(vars);\n        setProductImages(imgs);\n      } finally {\n        setLoading(false);\n      }\n    })();\n  }, [decodedTag]);\n\n  const matched = useMemo(() => {\n    if (!decodedTag) return [];\n\n    return products.filter((p: any) => {\n      const tags = Array.isArray(p.tags)\n        ? p.tags.map((t: string) => String(t).toLowerCase().trim())\n        : [];\n\n      return tags.includes(decodedTag);\n    });\n  }, [products, decodedTag]);\n\n  function getPrimaryImageUrl(productId: number) {\n    const primary = productImages.find(\n      (img: any) => img.product_id === productId && img.is_primary,\n    );\n    const anyImg = productImages.find((img: any) => img.product_id === productId);\n    return safeImg(primary?.url || anyImg?.url || \"/example.png\");\n  }\n\n  function getBestVariant(productId: number, basePrice?: number) {\n    const vars = productVariants.filter((v: any) => v.product_id === productId);\n    if (vars.length === 0)\n      return { price: basePrice ?? 0, mrp: null as number | null };\n    const best = vars.reduce((min: any, v: any) => (v.price < min.price ? v : min), vars[0]);\n    return { price: best.price, mrp: best.mrp ?? null };\n  }\n\n  return (\n    <>\n      <TopNavbar />\n\n      <main className=\"max-w-md mx-auto p-4 bg-white min-h-screen text-[#0B6EA9] flex flex-col gap-4\">\n        {/* Heading */}\n        <h2 className=\"text-lg font-semibold\">\n          Results for: <span className=\"font-bold\">\"{decodedTag}\"</span>\n        </h2>\n\n        {/* Loading State */}\n        {loading && (\n          <div className=\"mt-10 text-center text-base\">Loading productsâ€¦</div>\n        )}\n\n        {/* No Results */}\n        {!loading && matched.length === 0 && (\n          <div className=\"text-center mt-8 text-base\">\n            No results found.\n            <br />\n            <a\n              href=\"https://wa.me/252622073874\"\n              className=\"underline font-bold text-[#0B6EA9]\"\n            >\n              Contact us on WhatsApp ðŸ“©\n            </a>\n          </div>\n        )}\n\n        {/* Product Grid */}\n        {!loading && matched.length > 0 && (\n          <section className=\"grid grid-cols-2 gap-4\">\n            {matched.map((p: any) => {\n              const img = getPrimaryImageUrl(p.id);\n              const { price, mrp } = getBestVariant(p.id, p.base_price);\n\n              return (\n                <div\n                  key={p.id}\n                  className=\"bg-white rounded-2xl shadow-sm p-2 flex flex-col gap-2\"\n                >\n                  <Link href={`/product/${p.slug}`} className=\"block\">\n                    <div className=\"relative\">\n                      <Image\n                        src={img}\n                        alt={p.name}\n                        width={200}\n                        height={200}\n                        className=\"object-contain w-full h-40 rounded-lg bg-white\"\n                      />\n                    </div>\n                    <p className=\"mt-2 text-sm font-medium line-clamp-2\">{p.name}</p>\n                    <div className=\"mt-1 flex items-center gap-2\">\n                      <span className=\"font-bold text-md\">{price ?? \"â€”\"} SOS</span>\n                      {mrp && (\n                        <span className=\"text-xs line-through text-gray-400\">{mrp} SOS</span>\n                      )}\n                    </div>\n                  </Link>\n\n                  <button\n                    onClick={() =>\n                      window.dispatchEvent(\n                        new CustomEvent(\"cart:add\", { detail: { productId: p.id } }),\n                      )\n                    }\n                    className=\"w-full bg-[#0B6EA9] text-white rounded-full py-2 mt-auto\"\n                  >\n                    + Add to Cart\n                  </button>\n                </div>\n              );\n            })}\n          </section>\n        )}\n      </main>\n    </>\n  );\n}"],"names":[],"mappings":"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"}}]
}