(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4005],{117:(e,t,r)=>{"use strict";r.d(t,{N:()=>s});let s=(0,r(1958).UU)("https://ecfxrmhrfjqdmqewzrfz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjZnhybWhyZmpxZG1xZXd6cmZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDA0OTgsImV4cCI6MjA4MTkxNjQ5OH0.jtF3Qp9N7rH-KCWEMHU0atH7h-LQEJBKYO9Q2HdxkX0")},824:(e,t,r)=>{"use strict";r.d(t,{OrderModeProvider:()=>i,x:()=>d});var s=r(5155),l=r(2115);let n=(0,l.createContext)(null),a="order_mode_v1";function i({children:e}){let[t,r]=(0,l.useState)("online");return(0,l.useEffect)(()=>{let e=localStorage.getItem(a);("local"===e||"online"===e)&&r(e)},[]),(0,s.jsx)(n.Provider,{value:{mode:t,setMode:function(e){r(e),localStorage.setItem(a,e)}},children:e})}function d(){let e=(0,l.useContext)(n);if(!e)throw Error("useOrderMode must be used inside OrderModeProvider");return e}},4835:(e,t,r)=>{"use strict";r.d(t,{ES:()=>n,l0:()=>a,u1:()=>l});let s="payments_ledger_v1";function l(){try{return JSON.parse(localStorage.getItem(s)||"[]")}catch{return[]}}function n(e){let t=l();t.unshift({id:`PAY-${Date.now()}`,createdAt:new Date().toISOString(),...e,amount:Number(e.amount||0)}),localStorage.setItem(s,JSON.stringify(t))}function a(){localStorage.removeItem(s)}},6401:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>N});var s=r(5155),l=r(5772),n=r(8500),a=r.n(n),i=r(2115),d=r(8561),o=r(824);let c="local_orders_v2",u="credit_ledger_v1";function m(){try{return JSON.parse(localStorage.getItem(u)||"[]")}catch{return[]}}function f(){return m().reduce((e,t)=>e+Number(t.outstanding||0),0)}var x=r(4835),h=r(7270);function p(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(e||0))}let g=["EVC","MERCHANT","EDAHAB"],b=["PREMIER_WALLET","AMTEL"];function y(e){return"EVC"===e?"EVC":"MERCHANT"===e?"Merchant":"EDAHAB"===e?"E-Dahab":"PREMIER_WALLET"===e?"Premier Wallet":"Amtel"}function N(){let{mode:e}=(0,o.x)(),{items:t,setQty:r,removeItem:n,clearCart:N}=(0,d._)(),v=Array.isArray(t)?t:[],[j,w]=(0,i.useState)([]),[I,_]=(0,i.useState)([]),[S,E]=(0,i.useState)([]),[C,O]=(0,i.useState)(""),[k,A]=(0,i.useState)(null),[P,T]=(0,i.useState)("Local minimart order (test)"),[D,M]=(0,i.useState)(!1),[J,R]=(0,i.useState)("EVC"),[B,F]=(0,i.useState)(!1),[$,q]=(0,i.useState)(null),[L,H]=(0,i.useState)(0);(0,i.useEffect)(()=>{let e=Array.from(new Set(v.map(e=>e.productId)));if(!e.length){w([]),_([]),E([]);return}(async()=>{let t=await (0,h.wR)(e),[r,s]=await Promise.all([(0,h.TW)(e),(0,h.lv)(e)]);w(t),_(r),E(s)})()},[v]),(0,i.useEffect)(()=>{"online"===e?(O(""),A(null),T(""),M(!1),R("EVC"),F(!1),q(null),H(0)):(H(f()),P||T("Local minimart order (test)"))},[e]),(0,i.useEffect)(()=>{"local"===e&&H(f())},[e,$]),(0,i.useEffect)(()=>{if(!$)return;let e=setTimeout(()=>q(null),1500);return()=>clearTimeout(e)},[$]);let[V,W]=(0,i.useState)([]);(0,i.useEffect)(()=>{if("local"!==e)return void W([]);let t=C.trim();if(!t||k)return void W([]);let r=setTimeout(()=>{(0,h.cg)(t).then(e=>W(e)).catch(()=>W([]))},150);return()=>clearTimeout(r)},[e,C,k]);let Z=(0,i.useMemo)(()=>v.map(e=>{var t;let r=j.find(t=>t.id===e.productId);if(!r)return null;let s=Number(r?.base_price??0),l=function(e,t,r){if(null==t)return Number(r??0);let s=I.find(r=>r.product_id===e&&r.id===t);return Number(s?.price??r??0)}(e.productId,e.variantId??null,s),n=null==(t=e.variantId??null)?null:I.find(e=>e.id===t)?.label??null,a=n?`${r.name} (${n})`:r.name,i=function(e,t){if(null!=t){let r=S.find(r=>r.product_id===e&&r.variant_id===t)?.url;if(r)return(0,h.lN)(r)}let r=S.find(t=>t.product_id===e&&t.is_primary)?.url,s=S.find(t=>t.product_id===e)?.url;return(0,h.lN)(r||s||"/example.png")}(e.productId,e.variantId??null),d=Number(e.qty??1);return{ci:e,name:a,img:i,price:l,qty:d,lineTotal:l*d,key:`${e.productId}-${e.variantId??"base"}`}}).filter(Boolean),[v,j,I,S]),z=(0,i.useMemo)(()=>Z.reduce((e,t)=>e+(t?.lineTotal??0),0),[Z]),Q="local"===e?0:1.99*(z>0),U=z+Q,X=Z.length>0;async function Y(){let e;if(!X)return;if(D&&!k)return void alert("Select a customer for credit orders (name/phone).");let t={id:`LO-${Date.now()}`,createdAt:new Date().toISOString(),channel:"local",customer:k,note:P?.trim()||void 0,subtotal:z,deliveryFee:Q,total:U,isCredit:D,isPaid:!D,paymentMethod:D?null:J,items:Z.map(e=>({productId:e.ci.productId,variantId:e.ci.variantId??null,qty:e.qty,unitPrice:e.price,lineTotal:e.lineTotal,name:e.name}))};if((e=function(){try{return JSON.parse(localStorage.getItem(c)||"[]")}catch{return[]}}()).unshift(t),localStorage.setItem(c,JSON.stringify(e)),D&&k){let e,t,r;t=(e=m()).findIndex(e=>e.customerId===k.id),r=new Date().toISOString(),-1===t?e.unshift({customerId:k.id,name:k.name,phone:k.phone,outstanding:Number(U||0),lastOrderAt:r}):e[t]={...e[t],outstanding:Number(e[t].outstanding||0)+Number(U||0),lastOrderAt:r},localStorage.setItem(u,JSON.stringify(e)),q("✅ Credit order saved")}else(0,x.ES)({source:"SALE",method:J,amount:U,orderId:t.id,customer:k??void 0,note:"Local paid sale"}),q("✅ Paid order saved");N(),O(""),A(null),M(!1),R("EVC"),F(!1)}return(0,s.jsxs)("main",{className:"min-h-screen bg-white text-black",children:["local"===e?(0,s.jsx)("div",{className:"max-w-6xl mx-auto px-4 pt-4",children:(0,s.jsxs)("div",{className:"border rounded-2xl p-4 bg-white",children:[(0,s.jsxs)("div",{className:"rounded-xl border bg-[#FFF7ED] px-3 py-2 text-sm flex items-center justify-between",children:[(0,s.jsx)("div",{className:"font-semibold text-orange-800",children:"Credits due"}),(0,s.jsx)("div",{className:"font-extrabold text-orange-900",children:p(L)})]}),(0,s.jsxs)("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("label",{className:"text-xs text-gray-600",children:"Customer (type name or phone)"}),(0,s.jsx)("input",{value:k?`${k.name} • ${k.phone}`:C,onChange:e=>{A(null),O(e.target.value)},placeholder:"e.g. Hodan / 0622",className:"mt-1 w-full border rounded-xl px-3 py-2"}),!k&&V.length>0?(0,s.jsx)("div",{className:"absolute z-30 mt-2 w-full border bg-white rounded-xl shadow overflow-hidden",children:V.map(e=>(0,s.jsxs)("button",{onClick:()=>{A(e),O("")},className:"w-full px-3 py-2 text-left hover:bg-gray-50",children:[(0,s.jsx)("div",{className:"text-sm font-semibold",children:e.name}),(0,s.jsx)("div",{className:"text-xs text-gray-600",children:e.phone})]},e.id))}):null,k?(0,s.jsx)("button",{onClick:()=>{A(null),O("")},className:"mt-2 text-xs text-blue-600 hover:underline",children:"Change customer"}):(0,s.jsx)("div",{className:"mt-2 text-xs text-gray-500",children:"Optional: walk-in (not for credit)."})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-xs text-gray-600",children:"Staff note (optional)"}),(0,s.jsx)("input",{value:P,onChange:e=>T(e.target.value),className:"mt-1 w-full border rounded-xl px-3 py-2",placeholder:"e.g. delivery later"}),$?(0,s.jsx)("div",{className:"mt-2 text-xs text-green-700 font-semibold",children:$}):null]}),(0,s.jsxs)("div",{className:"md:col-span-2 flex items-center justify-between border rounded-xl px-3 py-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"font-semibold",children:"Credit"}),(0,s.jsx)("div",{className:"text-xs text-gray-600",children:"Tick if customer pays later (requires customer selected)."})]}),(0,s.jsx)("button",{onClick:()=>M(e=>!e),className:`h-9 px-4 rounded-full border text-sm font-semibold ${D?"border-red-600 bg-red-50 text-red-700":"bg-white"}`,children:D?"Credit: ON":"Credit: OFF"})]}),D?null:(0,s.jsxs)("div",{className:"md:col-span-2",children:[(0,s.jsx)("div",{className:"text-xs text-gray-600 mb-2",children:"Payment method"}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2",children:[g.map(e=>{let t=J===e;return(0,s.jsx)("button",{onClick:()=>R(e),className:`h-9 px-4 rounded-full border text-sm font-semibold ${t?"border-[#0B6EA9] bg-[#EAF4FB] text-[#0B6EA9]":"bg-white"}`,children:y(e)},e)}),(0,s.jsx)("button",{onClick:()=>F(e=>!e),className:"h-9 px-4 rounded-full border text-sm font-semibold bg-white",children:B?"Show less":"Show more"}),B?b.map(e=>{let t=J===e;return(0,s.jsx)("button",{onClick:()=>R(e),className:`h-9 px-4 rounded-full border text-sm font-semibold ${t?"border-[#0B6EA9] bg-[#EAF4FB] text-[#0B6EA9]":"bg-white"}`,children:y(e)},e)}):null]})]})]}),(0,s.jsxs)("div",{className:"mt-4 flex flex-wrap gap-2",children:[(0,s.jsx)(a(),{href:"/orders",className:"h-9 px-3 rounded-full border text-sm font-semibold hover:bg-gray-50",children:"Orders"}),(0,s.jsx)(a(),{href:"/payments",className:"h-9 px-3 rounded-full border text-sm font-semibold hover:bg-gray-50",children:"Payments"}),(0,s.jsx)(a(),{href:"/credits",className:"h-9 px-3 rounded-full border text-sm font-semibold hover:bg-gray-50",children:"Credits"})]})]})}):null,(0,s.jsxs)("div",{className:"max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-[1.6fr_0.9fr] gap-6",children:[(0,s.jsx)("section",{className:"bg-white",children:0===Z.length?(0,s.jsxs)("div",{className:"border rounded-2xl p-8 text-center",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Your cart is empty"}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Add items to checkout."}),(0,s.jsx)(a(),{href:"/",className:"inline-flex mt-5 px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-semibold",children:"Start shopping"})]}):(0,s.jsxs)("div",{className:"space-y-4",children:[Z.map(({ci:e,name:t,price:a,img:i,qty:d,lineTotal:o,key:c})=>(0,s.jsx)("div",{className:"border rounded-2xl p-4",children:(0,s.jsxs)("div",{className:"flex gap-4",children:[(0,s.jsx)("div",{className:"w-20 h-20 rounded-xl overflow-hidden bg-gray-50 flex-shrink-0",children:(0,s.jsx)(l.default,{src:(0,h.lN)(i),alt:t??"Product",width:120,height:120,className:"w-full h-full object-cover"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,s.jsxs)("div",{className:"min-w-0",children:[(0,s.jsx)("p",{className:"font-semibold truncate",children:t??"Item"}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-0.5",children:p(a)})]}),(0,s.jsx)("button",{onClick:()=>n(e.productId,e.variantId??null),className:"p-2 rounded-xl hover:bg-gray-50 text-sm text-gray-700","aria-label":"Remove item",children:"✕"})]}),(0,s.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"inline-flex items-center border rounded-full overflow-hidden",children:[(0,s.jsx)("button",{onClick:()=>r(e.productId,e.variantId??null,Math.max(1,d-1)),className:"px-4 py-2 hover:bg-gray-50",children:"−"}),(0,s.jsx)("span",{className:"px-4 py-2 text-sm font-semibold",children:d}),(0,s.jsx)("button",{onClick:()=>r(e.productId,e.variantId??null,d+1),className:"px-4 py-2 hover:bg-gray-50",children:"+"})]}),(0,s.jsx)("p",{className:"font-semibold",children:p(o)})]})]})]})},c)),(0,s.jsx)("div",{className:"pt-2",children:(0,s.jsx)("button",{onClick:N,className:"text-sm font-semibold text-red-600 hover:underline",children:"Clear cart"})})]})}),(0,s.jsx)("aside",{className:"bg-white",children:(0,s.jsxs)("div",{className:"border rounded-2xl p-5 sticky top-20",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-700",children:[(0,s.jsx)("span",{className:"text-base",children:"\uD83E\uDDFE"})," Summary"]}),(0,s.jsxs)("div",{className:"mt-4 space-y-2 text-sm",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-700",children:"Subtotal"}),(0,s.jsx)("span",{className:"font-semibold",children:p(z)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-700",children:"Delivery"}),(0,s.jsx)("span",{className:"font-semibold",children:p(Q)})]}),(0,s.jsxs)("div",{className:"border-t pt-3 flex justify-between",children:[(0,s.jsx)("span",{className:"font-semibold",children:"Total"}),(0,s.jsx)("span",{className:"font-semibold",children:p(U)})]})]}),"local"===e?(0,s.jsx)("button",{onClick:Y,disabled:!X,className:`mt-5 inline-flex w-full justify-center rounded-full py-3 text-sm font-semibold ${!X?"bg-gray-200 text-gray-500":"bg-blue-600 text-white hover:opacity-95"}`,children:D?"Save Credit Order":`Checkout (Paid: ${y(J)})`}):(0,s.jsx)(a(),{href:"/checkout",className:`mt-5 inline-flex w-full justify-center rounded-full py-3 text-sm font-semibold ${!X?"bg-gray-200 text-gray-500 pointer-events-none":"bg-blue-600 text-white hover:opacity-95"}`,children:"Checkout (Online)"}),"local"===e?(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-3",children:"Local paid checkouts appear in Payments."}):(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-3",children:"Online checkout uses your normal flow."})]})})]})]})}},6696:(e,t,r)=>{Promise.resolve().then(r.bind(r,6401))},7270:(e,t,r)=>{"use strict";r.d(t,{Cd:()=>h,HZ:()=>v,J:()=>m,TW:()=>g,Tl:()=>f,VR:()=>n,Xo:()=>o,cg:()=>y,dC:()=>u,eN:()=>d,fS:()=>N,hB:()=>c,iV:()=>a,ii:()=>i,lN:()=>l,lv:()=>b,ob:()=>x,wR:()=>p});var s=r(117);function l(e){let t=String(e??"").trim();return t&&(t.startsWith("/")||t.startsWith("http://")||t.startsWith("https://"))?t:"/example.png"}async function n(){let{data:e,error:t}=await s.N.from("categories").select("id,slug,img,name_so,name_en").order("id",{ascending:!0});if(t)throw t;let{data:r,error:l}=await s.N.from("subcategories").select("id,category_id,slug,img,name_so,name_en").order("id",{ascending:!0});if(l)throw l;let n=r??[];return(e??[]).map(e=>({...e,subcats:n.filter(t=>t.category_id===e.id)}))}async function a(){let{data:e,error:t}=await s.N.from("categories").select("*").order("id");if(t)throw t;return e??[]}async function i(){let{data:e,error:t}=await s.N.from("subcategories").select("*").order("id");if(t)throw t;return e??[]}async function d(){let{data:e,error:t}=await s.N.from("products").select("*").order("id");if(t)throw t;return e??[]}async function o(){let{data:e,error:t}=await s.N.from("product_variants").select("*").order("id");if(t)throw t;return e??[]}async function c(){let{data:e,error:t}=await s.N.from("product_images").select("*").order("is_primary",{ascending:!1});if(t)throw t;return e??[]}async function u(e){let{data:t,error:r}=await s.N.from("subcategories").select("*").eq("slug",e).maybeSingle();if(r)throw console.error("fetchSubcategoryBySlug error:",{slug:e,error:r}),r;return t}async function m(e){let{data:t,error:r}=await s.N.from("products").select("*").eq("subcategory_id",e).order("id",{ascending:!0});if(r)throw r;return t??[]}async function f(e){let{data:t,error:r}=await s.N.from("subsubcategories").select("*").eq("subcategory_id",e).order("id",{ascending:!0});return r?[]:t??[]}async function x(e){let t=Array.from(new Set(e)).filter(Boolean);if(0===t.length)return[];let{data:r,error:l}=await s.N.from("products").select("id,name,slug,long_description,category_id,subcategory_id,brand_id,is_discounted,base_price,tags,is_active").in("id",t);if(l)throw l;return r??[]}async function h(e){let t=Array.from(new Set(e)).filter(e=>null!=e);if(0===t.length)return[];let{data:r,error:l}=await s.N.from("product_variants").select("id,product_id,label,price,stock").in("id",t);if(l)throw l;return r??[]}async function p(e){return x(e)}async function g(e){let t=Array.from(new Set(e)).filter(Boolean);if(0===t.length)return[];let{data:r,error:l}=await s.N.from("product_variants").select("*").in("product_id",t).order("price",{ascending:!0});if(l)throw l;return r??[]}async function b(e){let t=Array.from(new Set(e)).filter(Boolean);if(0===t.length)return[];let{data:r,error:l}=await s.N.from("product_images").select("*").in("product_id",t).order("is_primary",{ascending:!1});if(l)throw l;return r??[]}async function y(e){let t=e.trim();if(!t)return[];let{data:r,error:l}=await s.N.from("customers").select("id,name,phone").or(`name.ilike.%${t}%,phone.ilike.%${t}%`).limit(8);if(l)throw l;return r??[]}async function N(e){let{data:t,error:r}=await s.N.from("orders").insert({customer_id:e.customer_id,delivery_name:e.delivery.name,delivery_phone:e.delivery.phone,delivery_address:e.delivery.address,delivery_note:e.delivery.note??null,total_amount:e.total_amount,status:"PENDING"}).select("id").single();if(r)throw r;return t}async function v(e,t){let r=t.map(t=>({order_id:e,product_id:t.productId,variant_id:t.variantId,quantity:t.qty,price_at_purchase:t.priceAtPurchase})),{error:l}=await s.N.from("order_items").insert(r);if(l)throw console.log("ORDER_ITEMS_INSERT_ERROR",l),l}},8561:(e,t,r)=>{"use strict";r.d(t,{CartProvider:()=>a,_:()=>i});var s=r(5155),l=r(2115);let n=(0,l.createContext)(null);function a({children:e}){let[t,r]=(0,l.useState)([]);function a(e,t){r(r=>r.filter(r=>r.productId!==e||r.variantId!==t))}return(0,l.useEffect)(()=>{let e=localStorage.getItem("cart");e&&r(JSON.parse(e))},[]),(0,l.useEffect)(()=>{localStorage.setItem("cart",JSON.stringify(t))},[t]),(0,s.jsx)(n.Provider,{value:{items:t,addItem:function(e,t,s=1){r(r=>r.find(r=>r.productId===e&&r.variantId===t)?r.map(r=>r.productId===e&&r.variantId===t?{...r,qty:r.qty+s}:r):[...r,{productId:e,variantId:t,qty:s}])},setQty:function(e,t,s){s<=0?a(e,t):r(r=>r.map(r=>r.productId===e&&r.variantId===t?{...r,qty:s}:r))},removeItem:a,clearCart:function(){r([])}},children:e})}function i(){let e=(0,l.useContext)(n);if(!e)throw Error("useCart must be used inside CartProvider");return e}}},e=>{e.O(0,[8500,1958,5772,8441,3794,7358],()=>e(e.s=6696)),_N_E=e.O()}]);