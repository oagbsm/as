(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3343],{117:(e,t,s)=>{"use strict";s.d(t,{N:()=>r});let r=(0,s(1958).UU)("https://ecfxrmhrfjqdmqewzrfz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjZnhybWhyZmpxZG1xZXd6cmZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDA0OTgsImV4cCI6MjA4MTkxNjQ5OH0.jtF3Qp9N7rH-KCWEMHU0atH7h-LQEJBKYO9Q2HdxkX0")},3934:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var r=s(5155),a=s(8500),n=s.n(a),i=s(2115),l=s(117);function d(e){let t=Number(e??0);return new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(Number.isFinite(t)?t:0)}function o(e){let t=Number(e??0);return Number.isFinite(t)?t:0}function m(e){return e?String(e).replace("T"," ").replace("Z",""):"…"}function c(){let[e,t]=(0,i.useState)(!0),[s,a]=(0,i.useState)(null),[c,u]=(0,i.useState)(null),[x,h]=(0,i.useState)([]),[p,f]=(0,i.useState)([]),[g,N]=(0,i.useState)(null);async function b(){t(!0),u(null);try{let[{data:e,error:t},{data:s,error:r}]=await Promise.all([l.N.from("orders").select("id,created_at,status,total_amount,customer_id,delivery_name,delivery_phone").order("created_at",{ascending:!1}).limit(500),l.N.from("payments").select("order_id,amount,status,method,created_at,reference").order("created_at",{ascending:!1}).limit(2e3)]);if(t)throw t;if(r)throw r;h(e??[]),f(s??[])}catch(e){u(e?.message||"Failed to load credits")}finally{t(!1)}}(0,i.useEffect)(()=>{let e=!0;return(async()=>{if(await b(),!e)return})(),()=>{e=!1}},[]);let j=(0,i.useMemo)(()=>{let e=new Map;for(let t of p){let s=Number(t.order_id);s&&"SUCCESS"===String(t.status||"").toUpperCase()&&e.set(s,(e.get(s)??0)+o(t.amount))}return e},[p]),y=(0,i.useMemo)(()=>{let e=x.map(e=>{let t=o(e.total_amount),s=j.get(Number(e.id))??0,r=Math.max(0,t-s);return{...e,total:t,paid:s,remaining:r}}).filter(e=>"CANCELLED"!==String(e.status||"").toUpperCase()&&e.remaining>0),t=new Map;for(let s of e){let e=null!=s.customer_id?`cid:${s.customer_id}`:s.delivery_phone?`phone:${s.delivery_phone}`:"unknown",r=s.delivery_phone??"",a=s.delivery_name??(null!=s.customer_id?`Customer #${s.customer_id}`:"Unknown"),n=t.get(e),i=n?.lastOrderAt?s.created_at>n.lastOrderAt?s.created_at:n.lastOrderAt:s.created_at;n?(n.outstanding+=s.remaining,n.ordersCount+=1,n.lastOrderAt=i,n.orders.push(s)):t.set(e,{key:e,customer_id:s.customer_id,name:a,phone:r,outstanding:s.remaining,ordersCount:1,lastOrderAt:i,orders:[s]})}return Array.from(t.values()).sort((e,t)=>t.outstanding-e.outstanding)},[x,j]),v=(0,i.useMemo)(()=>{let e=y.reduce((e,t)=>e+t.outstanding,0);return{outstanding:e,people:y.length,creditOrders:y.reduce((e,t)=>e+t.ordersCount,0)}},[y]),C=(0,i.useMemo)(()=>g?y.find(e=>e.key===g)??null:null,[g,y]);async function w(e){let t=`CREDITS-${e.orderId}-${Date.now()}-${Math.random().toString(16).slice(2)}`,s=await l.N.from("payments").insert({order_id:e.orderId,method:e.method,amount:e.amount,status:"SUCCESS",reference:t});if(s.error)throw s.error}async function _(e,t){let s=await l.N.from("orders").update({status:t}).eq("id",e);if(s.error)throw s.error}async function S(e,t){let s;if(e.remaining<=0)return;let r=(s=window.prompt("Payment method? Type: EVC, CASH, or MERCHANT","EVC")?.trim().toUpperCase())?"EVC"===s||"CASH"===s||"MERCHANT"===s?s:(alert("Invalid method. Use: EVC, CASH, MERCHANT"),null):null;if(!r)return;let n=e.remaining;if("PARTIAL"===t){let t=window.prompt(`Enter amount to pay (remaining: ${d(e.remaining)})`,"");if(!t)return;if((n=o(t))<=0)return alert("Amount must be > 0");if(n>e.remaining)return alert("Amount cannot exceed remaining")}try{a(g??String(e.id)),await w({orderId:e.id,amount:n,method:r});let t=Math.max(0,e.remaining-n);await _(e.id,t>0?"PENDING":"PAID"),await b()}catch(e){console.error(e),alert(e?.message||"Payment failed")}finally{a(null)}}return(0,r.jsx)("main",{className:"min-h-screen bg-gray-50 text-black",children:(0,r.jsxs)("div",{className:"max-w-6xl mx-auto px-4 py-6",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(n(),{href:"/admin",className:"text-sm text-blue-600 hover:underline",children:"← Admin"}),(0,r.jsx)("h1",{className:"text-xl font-semibold mt-2",children:"Credits"}),(0,r.jsx)("p",{className:"text-xs text-gray-600 mt-1",children:"Credits are derived from orders where (Total − SUCCESS payments) > 0."})]}),(0,r.jsxs)("div",{className:"text-xs text-gray-700 border bg-white rounded-2xl px-3 py-2",children:[(0,r.jsxs)("div",{children:["People owing: ",(0,r.jsx)("span",{className:"font-semibold",children:e?"…":v.people})]}),(0,r.jsxs)("div",{children:["Credit orders: ",(0,r.jsx)("span",{className:"font-semibold",children:e?"…":v.creditOrders})]}),(0,r.jsxs)("div",{children:["Outstanding: ",(0,r.jsx)("span",{className:"font-semibold",children:e?"…":d(v.outstanding)})]})]})]}),(0,r.jsx)("div",{className:"mt-3 flex items-center gap-2",children:(0,r.jsx)("button",{onClick:b,className:"px-4 py-2 rounded-full border bg-white text-sm font-semibold",disabled:e,children:e?"Refreshing…":"Refresh"})}),c?(0,r.jsx)("div",{className:"mt-4 border rounded-2xl p-4 bg-white text-sm text-red-600",children:c}):null,(0,r.jsx)("section",{className:"mt-4 grid grid-cols-2 lg:grid-cols-4 gap-3",children:(e?Array.from({length:8}):y).slice(0,16).map((e,t)=>(0,r.jsxs)("button",{onClick:()=>N(e.key),className:`text-left border rounded-2xl p-4 bg-white hover:border-blue-400 ${g===e?.key?"border-blue-600":""}`,children:[(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Customer"}),(0,r.jsx)("div",{className:"mt-1 text-sm font-semibold line-clamp-1",children:e?.name??"Unknown"}),(0,r.jsx)("div",{className:"mt-1 text-xs text-gray-600 line-clamp-1",children:e?.phone||"—"}),(0,r.jsx)("div",{className:"mt-3 text-xs text-gray-500",children:"Outstanding"}),(0,r.jsx)("div",{className:"mt-1 text-lg font-semibold",children:d(e?.outstanding)}),(0,r.jsxs)("div",{className:"mt-2 text-[11px] text-gray-500",children:[e?.ordersCount??0," orders • last ",m(e?.lastOrderAt)]})]},e?.key??t))}),(0,r.jsxs)("section",{className:"mt-6 border rounded-2xl bg-white p-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,r.jsx)("div",{className:"font-semibold",children:"Credit details"}),(0,r.jsx)("div",{className:"text-xs text-gray-600",children:C?(0,r.jsxs)(r.Fragment,{children:["Outstanding: ",(0,r.jsx)("span",{className:"font-semibold",children:d(C.outstanding)})]}):"Select a customer"})]}),C?(0,r.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,r.jsxs)("div",{className:"text-sm",children:[(0,r.jsx)("div",{className:"font-semibold",children:C.name}),(0,r.jsx)("div",{className:"text-gray-600",children:C.phone||"—"})]}),C.orders.map(e=>(0,r.jsxs)("div",{className:"border rounded-2xl p-4",children:[(0,r.jsxs)("div",{className:"flex justify-between gap-3",children:[(0,r.jsxs)("div",{className:"text-sm font-semibold",children:["Order #",e.id]}),(0,r.jsx)("div",{className:"text-xs text-gray-600",children:m(e.created_at)})]}),(0,r.jsxs)("div",{className:"mt-2 text-sm flex flex-wrap gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Total:"})," ",(0,r.jsx)("span",{className:"font-semibold",children:d(e.total)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Paid:"})," ",(0,r.jsx)("span",{className:"font-semibold",children:d(e.paid)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Remaining:"})," ",(0,r.jsx)("span",{className:"font-semibold",children:d(e.remaining)})]})]}),(0,r.jsxs)("div",{className:"mt-3 flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>S(e,"FULL"),disabled:null!=s,className:"px-4 py-2 rounded-full bg-green-600 text-white text-sm font-semibold disabled:opacity-60",children:s?"Working…":"Mark Paid"}),(0,r.jsx)("button",{onClick:()=>S(e,"PARTIAL"),disabled:null!=s,className:"px-4 py-2 rounded-full border text-sm font-semibold disabled:opacity-60",children:"Pay partial"})]})]},e.id))]}):(0,r.jsx)("div",{className:"mt-3 text-sm text-gray-600",children:"Tap a customer card above to manage their credit."})]})]})})}},6938:(e,t,s)=>{Promise.resolve().then(s.bind(s,3934))}},e=>{e.O(0,[8500,1958,8441,3794,7358],()=>e(e.s=6938)),_N_E=e.O()}]);