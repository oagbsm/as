(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[39],{117:(e,t,s)=>{"use strict";s.d(t,{N:()=>r});let r=(0,s(1958).UU)("https://ecfxrmhrfjqdmqewzrfz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjZnhybWhyZmpxZG1xZXd6cmZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDA0OTgsImV4cCI6MjA4MTkxNjQ5OH0.jtF3Qp9N7rH-KCWEMHU0atH7h-LQEJBKYO9Q2HdxkX0")},7850:(e,t,s)=>{Promise.resolve().then(s.bind(s,9774))},9774:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>m});var r=s(5155),a=s(8500),l=s.n(a),i=s(2115),n=s(117);let d=["EVC","eDahab","MERCHANT","CASH","PREMIER"];function c(e){let t=Number(e??0);return Number.isFinite(t)?t:0}function o(e){return new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(c(e))}function m(){let[e,t]=(0,i.useState)(!0),[s,a]=(0,i.useState)(null),[m,u]=(0,i.useState)([]),[x,h]=(0,i.useState)(""),[p,g]=(0,i.useState)([]),[f,b]=(0,i.useState)(""),[v,N]=(0,i.useState)("062"),[j,y]=(0,i.useState)("MATO minmart"),[w,S]=(0,i.useState)([]),[C,_]=(0,i.useState)(!1),[k,I]=(0,i.useState)(!1),[E,M]=(0,i.useState)("phone"),[q,P]=(0,i.useState)(!1),[O,D]=(0,i.useState)("EVC"),[T,A]=(0,i.useState)(0),[F,V]=(0,i.useState)(!1),[$,z]=(0,i.useState)(null);(0,i.useEffect)(()=>{let e=!0;return(async()=>{try{t(!0),a(null);let{data:s,error:r}=await n.N.from("product_variants").select("id,product_id,label,price,stock,products(name,slug)").order("id",{ascending:!0}).limit(5e3);if(r)throw r;if(!e)return;u(s??[])}catch(t){if(!e)return;a(t?.message||"Failed to load variants")}finally{e&&t(!1)}})(),()=>{e=!1}},[]);let J=(0,i.useMemo)(()=>{let e=x.trim().toLowerCase();return e?m.filter(t=>{let s=String(t.products?.name??"").toLowerCase(),r=String(t.label??"").toLowerCase(),a=String(t.products?.slug??"").toLowerCase();return s.includes(e)||r.includes(e)||a.includes(e)||String(t.id).includes(e)}):m},[m,x]),Z=(0,i.useMemo)(()=>p.reduce((e,t)=>e+t.price*t.qty,0),[p]);function B(e,t){g(s=>s.map(s=>s.variant_id===e?{...s,qty:Math.max(1,Math.floor(t))}:s).filter(e=>e.qty>0))}function G(){setTimeout(()=>_(!1),120)}function H(){g([]),b(""),N("062"),y("MATO minmart"),P(!1),D("EVC"),A(0),S([]),_(!1)}async function L(){let e=v.trim(),t=f.trim();if(!e)return null;let{data:s,error:r}=await n.N.from("customers").select("id,name,phone").eq("phone",e).limit(1);if(r)throw r;if(s&&s.length>0)return Number(s[0].id);let a=t||e,{data:l,error:i}=await n.N.from("customers").insert({name:a,phone:e}).select("id").single();if(i)throw i;return l?Number(l.id):null}async function Q(e){let{data:t,error:s}=await n.N.from("orders").insert({customer_id:e.customerId,total_amount:e.total,status:e.status,delivery_name:f.trim()||null,delivery_phone:v.trim()||null,delivery_address:j.trim()||"MATO minmart",delivery_note:null}).select("id").single();if(s)throw s;let r=Number(t.id),a=p.map(e=>({order_id:r,product_id:e.product_id,variant_id:e.variant_id,quantity:e.qty,price_at_purchase:e.price})),{error:l}=await n.N.from("order_items").insert(a);if(l)throw l;return r}async function U(){if(0!==p.length){if(!v.trim())return void alert("Phone number is required.");V(!0),a(null),z(null);try{let e=await L(),t=await Q({customerId:e,status:"PAID",total:Z}),s=Math.min(c(T),Z),{error:r}=await n.N.from("payments").insert({order_id:t,method:O,amount:s,status:"SUCCESS",reference:null});if(r)throw r;z(`âœ… Paid sale saved. Order #${t}`),H()}catch(e){a(e?.message||"Failed to save paid sale")}finally{V(!1),P(!1)}}}async function R(){if(0!==p.length){if(!v.trim())return void alert("Phone number is required.");V(!0),a(null),z(null);try{let e=await L(),t=await Q({customerId:e,status:"PENDING",total:Z});z(`ðŸŸ¡ Credit order saved (PENDING). Order #${t}`),H()}catch(e){a(e?.message||"Failed to save credit order")}finally{V(!1)}}}return(0,i.useEffect)(()=>{A(Z)},[Z]),(0,i.useEffect)(()=>{let e=!0,t=("name"===E?f:v).trim();if(!("name"===E&&t.length>=2||"phone"===E&&t.replace(/\D/g,"").length>=3)){S([]),_(!1);return}let s=setTimeout(async()=>{try{I(!0);let s=t.replace(/%/g,""),{data:r,error:a}=await n.N.from("customers").select("id,name,phone").or(`name.ilike.%${s}%,phone.ilike.%${s}%`).order("id",{ascending:!1}).limit(10);if(a)throw a;if(!e)return;S(r??[]),_(!0)}catch{if(!e)return;S([]),_(!1)}finally{e&&I(!1)}},250);return()=>{e=!1,clearTimeout(s)}},[f,v,E]),(0,r.jsx)("main",{className:"min-h-screen bg-gray-50 text-black",children:(0,r.jsxs)("div",{className:"max-w-7xl mx-auto px-4 py-6",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(l(),{href:"/admin",className:"text-sm text-blue-600 hover:underline",children:"â† Admin"}),(0,r.jsx)("h1",{className:"text-xl font-semibold mt-2",children:"Fast Sale"}),(0,r.jsx)("p",{className:"text-xs text-gray-600 mt-1",children:"Quick sales + credit orders (variant-based, so it matches your DB schema)."})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsx)("div",{className:"text-xs text-gray-600",children:"Today"}),(0,r.jsx)("div",{className:"text-sm font-semibold",children:new Date().toISOString().slice(0,10)})]})]}),s?(0,r.jsx)("div",{className:"mt-4 border rounded-2xl p-4 bg-white text-sm text-red-600",children:s}):null,$?(0,r.jsx)("div",{className:"mt-4 border rounded-2xl p-4 bg-white text-sm text-green-700",children:$}):null,(0,r.jsxs)("div",{className:"mt-4 grid grid-cols-1 lg:grid-cols-[1.4fr_0.9fr] gap-4",children:[(0,r.jsxs)("section",{className:"border rounded-2xl bg-white p-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,r.jsx)("div",{className:"font-semibold",children:"Products"}),(0,r.jsx)("input",{value:x,onChange:e=>h(e.target.value),placeholder:"Search (name, label, slug, id)â€¦",className:"border rounded-full px-3 py-2 text-sm w-[220px] bg-white"})]}),(0,r.jsx)("div",{className:"mt-3 grid grid-cols-2 lg:grid-cols-4 gap-3",children:(e?Array.from({length:12}):J.slice(0,200)).map((t,s)=>{if(e)return(0,r.jsx)("div",{className:"h-28 bg-gray-100 rounded-2xl"},s);let a=String(t.products?.name??`Product #${t.product_id}`),l=String(t.label??""),i=c(t.price),n=c(t.stock);return(0,r.jsxs)("button",{onClick:()=>{let e,s,r;return e=String(t.products?.name??`Product #${t.product_id}`),s=String(t.label??""),r=c(t.price),void g(a=>{let l=a.findIndex(e=>e.variant_id===t.id);if(l>=0){let e=[...a];return e[l]={...e[l],qty:e[l].qty+1},e}return[...a,{variant_id:t.id,product_id:t.product_id,name:e,label:s,price:r,qty:1,stock:c(t.stock)}]})},className:"text-left border rounded-2xl p-3 hover:bg-gray-50 active:scale-[0.99]",title:`Variant #${t.id}`,children:[(0,r.jsx)("div",{className:"text-sm font-semibold line-clamp-2",children:a}),(0,r.jsx)("div",{className:"mt-1 text-xs text-gray-600 line-clamp-1",children:l}),(0,r.jsxs)("div",{className:"mt-2 flex items-center justify-between text-sm",children:[(0,r.jsx)("div",{className:"font-semibold",children:o(i)}),(0,r.jsxs)("div",{className:`text-xs ${n<=0?"text-red-600":"text-gray-600"}`,children:["Stock: ",n]})]})]},t.id)})})]}),(0,r.jsxs)("aside",{className:"border rounded-2xl bg-white p-4 lg:sticky lg:top-6 h-fit",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("div",{className:"font-semibold",children:"Cart"}),(0,r.jsx)("button",{onClick:H,className:"text-xs px-3 py-2 rounded-full border hover:bg-gray-50",children:"Clear"})]}),(0,r.jsx)("div",{className:"mt-3 space-y-2",children:0===p.length?(0,r.jsx)("div",{className:"text-sm text-gray-600",children:"No items."}):p.map(e=>(0,r.jsxs)("div",{className:"border rounded-xl p-3",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,r.jsxs)("div",{className:"min-w-0",children:[(0,r.jsx)("div",{className:"text-sm font-semibold line-clamp-2",children:e.name}),(0,r.jsxs)("div",{className:"text-xs text-gray-600",children:[e.label," â€¢ Variant #",e.variant_id]}),(0,r.jsxs)("div",{className:"mt-1 flex items-center justify-between gap-2",children:[(0,r.jsx)("div",{className:"text-sm font-semibold",children:o(e.price)}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500",children:"Edit"}),(0,r.jsx)("input",{type:"number",step:"0.01",value:String(e.price),onChange:t=>{var s;let r;return s=e.variant_id,r=Math.max(0,c(Number(t.target.value))),void g(e=>e.map(e=>e.variant_id===s?{...e,price:r}:e))},className:"w-24 text-right border rounded-xl px-2 py-1 text-sm"})]})]})]}),(0,r.jsx)("button",{onClick:()=>{var t;return t=e.variant_id,void g(e=>e.filter(e=>e.variant_id!==t))},className:"text-xs px-2 py-1 rounded-full border hover:bg-gray-50",children:"Remove"})]}),(0,r.jsxs)("div",{className:"mt-2 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"text-xs text-gray-600",children:["Stock: ",e.stock]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>B(e.variant_id,e.qty-1),className:"w-9 h-9 rounded-full border hover:bg-gray-50",children:"âˆ’"}),(0,r.jsx)("input",{value:String(e.qty),onChange:t=>B(e.variant_id,Number(t.target.value)),className:"w-14 text-center border rounded-xl py-2"}),(0,r.jsx)("button",{onClick:()=>B(e.variant_id,e.qty+1),className:"w-9 h-9 rounded-full border hover:bg-gray-50",children:"+"})]})]}),(0,r.jsx)("div",{className:"mt-2 text-sm font-semibold text-right",children:o(e.price*e.qty)})]},e.variant_id))}),(0,r.jsxs)("div",{className:"mt-4 border-t pt-4",children:[(0,r.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Subtotal"}),(0,r.jsx)("span",{className:"font-semibold",children:o(Z)})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("div",{className:"text-sm font-semibold",children:"Customer"}),(0,r.jsxs)("div",{className:"mt-2 grid grid-cols-1 gap-2",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("input",{value:v,onChange:e=>{M("phone"),N(e.target.value)},onFocus:()=>_(!0),onBlur:G,placeholder:"Phone (Somalia)",className:"border rounded-xl px-3 py-2 text-sm w-full"}),C&&(k||w.length>0)?(0,r.jsxs)("div",{className:"absolute z-20 mt-2 w-full bg-white border rounded-2xl shadow-lg overflow-hidden",children:[(0,r.jsx)("div",{className:"px-3 py-2 text-xs text-gray-600 border-b",children:k?"Searchingâ€¦":"Select customer"}),(0,r.jsx)("div",{className:"max-h-64 overflow-auto",children:0===w.length?(0,r.jsx)("div",{className:"px-3 py-3 text-sm text-gray-600",children:"No matches."}):w.map(e=>(0,r.jsxs)("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:()=>{b(String(e?.name??"")),N(String(e?.phone??"")),_(!1)},className:"w-full text-left px-3 py-2 hover:bg-gray-50",children:[(0,r.jsx)("div",{className:"text-sm font-semibold line-clamp-1",children:e.name||e.phone}),(0,r.jsx)("div",{className:"text-xs text-gray-600",children:e.phone})]},String(e.id)))})]}):null]}),(0,r.jsx)("input",{value:f,onChange:e=>{M("name"),b(e.target.value)},onFocus:()=>_(!0),onBlur:G,placeholder:"Name (optional)",className:"border rounded-xl px-3 py-2 text-sm"}),(0,r.jsx)("input",{value:j,onChange:e=>y(e.target.value),placeholder:"Delivery location",className:"border rounded-xl px-3 py-2 text-sm"})]})]}),(0,r.jsxs)("div",{className:"mt-4 grid grid-cols-2 gap-2",children:[(0,r.jsx)("button",{onClick:()=>P(!0),disabled:0===p.length||F,className:"rounded-full py-3 text-sm font-semibold bg-blue-600 text-white disabled:opacity-50",children:"Pay now"}),(0,r.jsx)("button",{onClick:R,disabled:0===p.length||F,className:"rounded-full py-3 text-sm font-semibold border disabled:opacity-50",children:"Credit"})]}),(0,r.jsxs)("p",{className:"mt-3 text-xs text-gray-500",children:["Credit orders save as ",(0,r.jsx)("span",{className:"font-semibold",children:"PENDING"})," and do not create payment rows."]})]})]})]}),q?(0,r.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-end lg:items-center justify-center p-4 z-50",children:(0,r.jsxs)("div",{className:"w-full max-w-lg bg-white rounded-2xl p-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("div",{className:"font-semibold",children:"Take payment"}),(0,r.jsx)("button",{onClick:()=>P(!1),className:"text-xs px-3 py-2 rounded-full border hover:bg-gray-50",children:"Close"})]}),(0,r.jsxs)("div",{className:"mt-3 grid grid-cols-1 gap-3",children:[(0,r.jsxs)("label",{className:"text-sm",children:["Method (default EVC)",(0,r.jsx)("select",{value:O,onChange:e=>D(e.target.value),className:"mt-1 w-full border rounded-xl px-3 py-2",children:d.map(e=>(0,r.jsx)("option",{value:e,children:e},e))})]}),(0,r.jsxs)("label",{className:"text-sm",children:["Amount",(0,r.jsx)("input",{type:"number",value:String(T),onChange:e=>A(Number(e.target.value)),className:"mt-1 w-full border rounded-xl px-3 py-2"}),(0,r.jsxs)("div",{className:"mt-1 text-xs text-gray-600",children:["Total: ",(0,r.jsx)("span",{className:"font-semibold",children:o(Z)})]})]}),(0,r.jsx)("button",{onClick:U,disabled:F||0===p.length,className:"w-full rounded-full py-3 text-sm font-semibold bg-blue-600 text-white disabled:opacity-50",children:F?"Savingâ€¦":`Confirm payment â€¢ ${o(Math.min(T,Z))}`}),(0,r.jsxs)("div",{className:"text-xs text-gray-500",children:["This creates: ",(0,r.jsx)("b",{children:"orders(PAID)"})," + ",(0,r.jsx)("b",{children:"order_items"})," + ",(0,r.jsx)("b",{children:"payments(SUCCESS)"}),"."]})]})]})}):null]})})}}},e=>{e.O(0,[500,958,441,794,358],()=>e(e.s=7850)),_N_E=e.O()}]);