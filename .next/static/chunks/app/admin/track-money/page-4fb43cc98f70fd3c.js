(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[355],{117:(e,t,s)=>{"use strict";s.d(t,{N:()=>a});let a=(0,s(1958).UU)("https://ecfxrmhrfjqdmqewzrfz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjZnhybWhyZmpxZG1xZXd6cmZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDA0OTgsImV4cCI6MjA4MTkxNjQ5OH0.jtF3Qp9N7rH-KCWEMHU0atH7h-LQEJBKYO9Q2HdxkX0")},4602:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>m});var a=s(5155),r=s(8500),n=s.n(r),l=s(2115),i=s(117);let d=["EVC","eDahab","MERCHANT","CASH","PREMIER"];function o(e){let t=Number(e??0);return Number.isFinite(t)?t:0}function c(e){return new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(o(e))}function m(){let e=new Date().toISOString().slice(0,10),[t,s]=(0,l.useState)(e),[r,m]=(0,l.useState)(e),[x,u]=(0,l.useState)(!0),[h,g]=(0,l.useState)(null),[f,p]=(0,l.useState)([]),[b,N]=(0,l.useState)([]),[v,y]=(0,l.useState)([]),[j,_]=(0,l.useState)([]),[w,S]=(0,l.useState)([]),[E,I]=(0,l.useState)(!1),[C,$]=(0,l.useState)([]),[O,k]=(0,l.useState)(!1);(0,l.useEffect)(()=>{let e=!0;return(async()=>{try{u(!0),g(null);let s=new Date(`${r}T00:00:00.000Z`);s.setUTCDate(s.getUTCDate()+1);let a=s.toISOString(),[n,l,d,o]=await Promise.all([i.N.from("payments").select("id,order_id,method,amount,status,reference,created_at").eq("status","SUCCESS").gte("created_at",`${t}T00:00:00.000Z`).lt("created_at",a).order("created_at",{ascending:!1}).limit(5e3),i.N.from("expenses").select("id,title,category,amount,notes,expense_date,paid_method,created_at").gte("expense_date",t).lte("expense_date",r).order("expense_date",{ascending:!1}).limit(5e3),i.N.from("inventory_payments").select("id,batch_id,method,amount,status,reference,created_at").eq("status","SUCCESS").gte("created_at",`${t}T00:00:00.000Z`).lt("created_at",a).order("created_at",{ascending:!1}).limit(5e3),i.N.from("inventory_batches").select("id,variant_id,qty_received,total_cost,unit_cost,received_at").gte("received_at",`${t}T00:00:00.000Z`).lt("received_at",a).order("received_at",{ascending:!1}).limit(5e3)]);if(n.error)throw n.error;if(l.error)throw l.error;if(d.error)throw d.error;if(o.error)throw o.error;let c=[],m=!1;try{let e=await i.N.from("inventory_wastage").select("id,variant_id,qty,wastage_at,reason,note").gte("wastage_at",`${t}T00:00:00.000Z`).lt("wastage_at",a).order("wastage_at",{ascending:!1}).limit(5e3);e.error?m=!0:c=e.data??[]}catch{m=!0}let x=[],h=!1,f=await i.N.from("wallet_openings").select("*").order("created_at",{ascending:!1}).limit(2e3);if(f.error?h=!0:x=f.data??[],!e)return;p(n.data??[]),N(l.data??[]),y(d.data??[]),_(o.data??[]),S(c),I(m),$(x),k(h)}catch(t){if(!e)return;g(t?.message||"Failed to load track money data")}finally{e&&u(!1)}})(),()=>{e=!1}},[t,r]);let R=(0,l.useMemo)(()=>{let e={};for(let t of C){let s=String(t.method??"").trim();s&&null==e[s]&&(e[s]=o(t.amount))}return e},[C]),T=(0,l.useMemo)(()=>{let e={},t={};for(let s of d)e[s]=0,t[s]=0;for(let t of f){let s=String(t.method??"").trim(),a=o(t.amount);s&&(e[s]=(e[s]??0)+a)}for(let e of b){let s=String(e.paid_method??"").trim(),a=o(e.amount);s&&(t[s]=(t[s]??0)+a)}for(let e of v){let s=String(e.method??"").trim(),a=o(e.amount);s&&(t[s]=(t[s]??0)+a)}let s={};for(let a of d){let r=R[a]??0;s[a]=r+(e[a]??0)-(t[a]??0)}let a=f.reduce((e,t)=>e+o(t.amount),0),r=b.reduce((e,t)=>e+o(t.amount),0),n=v.reduce((e,t)=>e+o(t.amount),0),l=j.reduce((e,t)=>e+o(t.total_cost),0),i={};for(let e of j){let t=String(e.variant_id??""),s=o(e.qty_received),a=o(e.unit_cost);!t||s<=0||a<=0||(i[t]||(i[t]={qty:0,cost:0}),i[t].qty+=s,i[t].cost+=s*a)}let c={};for(let e of Object.keys(i))c[e]=i[e].cost/Math.max(1,i[e].qty);let m=w.reduce((e,t)=>{let s=String(t.variant_id??"");return e+o(t.qty)*(c[s]??0)},0),x=a-l-m;return{inflowBy:e,outflowBy:t,wallet:s,totalSales:a,totalExpenses:r,totalInvPaid:n,inventoryCost:l,wastageCost:m,grossProfit:x,netProfit:x-r}},[f,b,v,j,w,R]),Z=(0,l.useMemo)(()=>{let e=[];for(let t of f)e.push({when:t.created_at,type:"SALE",method:String(t.method??""),in_amount:o(t.amount),out_amount:0,ref:t.reference?String(t.reference):`order#${t.order_id}`});for(let t of b)e.push({when:t.expense_date,type:"EXPENSE",method:String(t.paid_method??""),in_amount:0,out_amount:o(t.amount),ref:t.title?String(t.title):`expense#${t.id}`});for(let t of v)e.push({when:t.created_at,type:"INVENTORY",method:String(t.method??""),in_amount:0,out_amount:o(t.amount),ref:t.reference?String(t.reference):`batch#${t.batch_id}`});return e.sort((e,t)=>String(t.when).localeCompare(String(e.when))),e},[f,b,v]);return(0,a.jsx)("main",{className:"min-h-screen bg-gray-50 text-black",children:(0,a.jsxs)("div",{className:"max-w-7xl mx-auto px-4 py-6",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(n(),{href:"/admin",className:"text-sm text-blue-600 hover:underline",children:"← Admin"}),(0,a.jsx)("h1",{className:"text-xl font-semibold mt-2",children:"Track Money"}),(0,a.jsx)("p",{className:"text-xs text-gray-600 mt-1",children:"Wallet balances = Opening + Sales − Inventory payments − Expenses."}),(0,a.jsx)("p",{className:"text-xs text-gray-600 mt-1",children:"Profit = Revenue − Inventory cost(received) − Wastage − Expenses."})]}),(0,a.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,a.jsx)("label",{className:"text-xs text-gray-600",children:"From"}),(0,a.jsx)("input",{type:"date",value:t,onChange:e=>s(e.target.value),className:"border rounded-full px-3 py-2 text-sm bg-white"}),(0,a.jsx)("label",{className:"text-xs text-gray-600",children:"To"}),(0,a.jsx)("input",{type:"date",value:r,onChange:e=>m(e.target.value),className:"border rounded-full px-3 py-2 text-sm bg-white"})]}),(0,a.jsx)("button",{onClick:function(){let e=new Blob([function(e){let t=Array.isArray(e)?e:[];if(0===t.length)return"";let s=new Set;for(let e of t)Object.keys(e??{}).forEach(e=>s.add(e));let a=[...s],r=e=>{let t=null==e?"":String(e);return`"${t.replace(/"/g,'""')}"`},n=a.map(r).join(","),l=t.map(e=>a.map(t=>r(e[t])).join(",")).join("\n");return`${n}
${l}`}(Z.map(e=>({when:e.when,type:e.type,method:e.method,in_amount:e.in_amount,out_amount:e.out_amount,ref:e.ref})))],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(e),a=document.createElement("a");a.href=s,a.download=`wallet-statement_${t}_to_${r}.csv`,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(s)},disabled:x||0===Z.length,className:"px-4 py-2 rounded-full border bg-white text-sm font-semibold hover:bg-gray-50 disabled:opacity-50",children:"Export wallet statement (CSV)"})]})]}),h?(0,a.jsx)("div",{className:"mt-4 border rounded-2xl p-4 bg-white text-sm text-red-600",children:h}):null,O?(0,a.jsxs)("div",{className:"mt-4 border rounded-2xl p-4 bg-white text-sm text-amber-700",children:["Note: ",(0,a.jsx)("span",{className:"font-semibold",children:"wallet_openings"})," table not found (or blocked by RLS). Openings are treated as ",(0,a.jsx)("span",{className:"font-semibold",children:"0"}),"."]}):null,E?(0,a.jsxs)("div",{className:"mt-4 border rounded-2xl p-4 bg-white text-sm text-amber-700",children:["Note: ",(0,a.jsx)("span",{className:"font-semibold",children:"wastage"})," table not found (or blocked by RLS). Wastage cost is treated as ",(0,a.jsx)("span",{className:"font-semibold",children:"0"}),"."]}):null,(0,a.jsxs)("section",{className:"mt-4 grid grid-cols-2 lg:grid-cols-3 gap-3",children:[(0,a.jsxs)("div",{className:"border rounded-2xl p-4 bg-white",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Revenue (Sales)"}),(0,a.jsx)("div",{className:"mt-1 text-lg font-semibold",children:x?"…":c(T.totalSales)})]}),(0,a.jsxs)("div",{className:"border rounded-2xl p-4 bg-white",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Inventory cost (received)"}),(0,a.jsx)("div",{className:"mt-1 text-lg font-semibold",children:x?"…":c(T.inventoryCost)}),(0,a.jsxs)("div",{className:"mt-2 text-[11px] text-gray-500 leading-4",children:["Paid to suppliers: ",x?"…":c(T.totalInvPaid)]})]}),(0,a.jsxs)("div",{className:"border rounded-2xl p-4 bg-white",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Wastage cost"}),(0,a.jsx)("div",{className:"mt-1 text-lg font-semibold",children:x?"…":c(T.wastageCost)})]}),(0,a.jsxs)("div",{className:"border rounded-2xl p-4 bg-white",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Gross profit"}),(0,a.jsx)("div",{className:"mt-1 text-lg font-semibold",children:x?"…":c(T.grossProfit)}),(0,a.jsx)("div",{className:"mt-2 text-[11px] text-gray-500 leading-4",children:"Revenue − Inventory − Wastage"})]}),(0,a.jsxs)("div",{className:"border rounded-2xl p-4 bg-white",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Expenses"}),(0,a.jsx)("div",{className:"mt-1 text-lg font-semibold",children:x?"…":c(T.totalExpenses)})]}),(0,a.jsxs)("div",{className:"border rounded-2xl p-4 bg-white",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Net profit"}),(0,a.jsx)("div",{className:`mt-1 text-lg font-semibold ${!x&&T.netProfit<0?"text-red-600":""}`,children:x?"…":c(T.netProfit)}),(0,a.jsx)("div",{className:"mt-2 text-[11px] text-gray-500 leading-4",children:"Gross profit − Expenses"})]})]}),(0,a.jsxs)("section",{className:"mt-4 border rounded-2xl bg-white p-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,a.jsx)("div",{className:"font-semibold",children:"Wallet balances"}),(0,a.jsx)("div",{className:"text-xs text-gray-600",children:"Default wallets shown (even if your enum doesn’t include them yet)."})]}),(0,a.jsx)("div",{className:"mt-3 grid grid-cols-2 lg:grid-cols-5 gap-3",children:d.map(e=>{let t=T.wallet[e]??0,s=t<-1e-4;return(0,a.jsxs)("div",{className:"border rounded-2xl p-4",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:e}),(0,a.jsx)("div",{className:`mt-1 text-lg font-semibold ${s?"text-red-600":""}`,children:x?"…":c(t)}),(0,a.jsxs)("div",{className:"mt-2 text-[11px] text-gray-500 leading-4",children:["In: ",x?"…":c(T.inflowBy[e]??0)," • Out:"," ",x?"…":c(T.outflowBy[e]??0)]}),s?(0,a.jsx)("div",{className:"mt-2 text-[11px] text-red-600",children:"Negative balance"}):null]},e)})})]}),(0,a.jsxs)("section",{className:"mt-4 border rounded-2xl bg-white p-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,a.jsx)("div",{className:"font-semibold",children:"Recent wallet statement"}),(0,a.jsxs)("div",{className:"text-xs text-gray-600",children:["Showing ",x?"…":Math.min(Z.length,100)," rows"]})]}),(0,a.jsx)("div",{className:"mt-3 space-y-2",children:(x?Array.from({length:8}):Z.slice(0,100)).map((e,t)=>{if(x)return(0,a.jsx)("div",{className:"h-10 bg-gray-100 rounded-xl"},t);let s=e.in_amount>0;return(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm border rounded-xl px-3 py-2",children:[(0,a.jsxs)("div",{className:"min-w-0",children:[(0,a.jsxs)("div",{className:"font-semibold",children:[e.type," • ",e.method]}),(0,a.jsxs)("div",{className:"text-xs text-gray-600 truncate",children:[String(e.when)," • ",e.ref]})]}),(0,a.jsx)("div",{className:`font-semibold ${s?"text-green-700":"text-red-600"}`,children:s?`+${c(e.in_amount)}`:`-${c(e.out_amount)}`})]},`${e.type}-${t}`)})})]})]})})}},9006:(e,t,s)=>{Promise.resolve().then(s.bind(s,4602))}},e=>{e.O(0,[500,958,441,794,358],()=>e(e.s=9006)),_N_E=e.O()}]);