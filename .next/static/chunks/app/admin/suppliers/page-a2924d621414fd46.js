(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[128],{117:(e,t,s)=>{"use strict";s.d(t,{N:()=>a});let a=(0,s(1958).UU)("https://ecfxrmhrfjqdmqewzrfz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjZnhybWhyZmpxZG1xZXd6cmZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDA0OTgsImV4cCI6MjA4MTkxNjQ5OH0.jtF3Qp9N7rH-KCWEMHU0atH7h-LQEJBKYO9Q2HdxkX0")},2649:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>o});var a=s(5155),r=s(8500),l=s.n(r),i=s(2115),d=s(117);function n(e){let t=Number(e??0);return Number.isFinite(t)?t:0}function c(e){return new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(n(e))}let m=["EVC","eDahab","MERCHANT","CASH","PREMIER"];function o(){let[e,t]=(0,i.useState)(!0),[s,r]=(0,i.useState)(null),[o,x]=(0,i.useState)([]),[u,h]=(0,i.useState)([]),[p,b]=(0,i.useState)([]),[N,j]=(0,i.useState)([]),[y,f]=(0,i.useState)(""),[v,g]=(0,i.useState)(null),[_,w]=(0,i.useState)(!1),[S,C]=(0,i.useState)(null),[k,M]=(0,i.useState)(""),[I,P]=(0,i.useState)("EVC"),[$,E]=(0,i.useState)(""),[F,U]=(0,i.useState)(!1);(0,i.useEffect)(()=>{let e=!0;return(async()=>{try{t(!0),r(null);let[s,a,l,i]=await Promise.all([d.N.from("suppliers").select("id,name,phone,email,address,created_at").order("name",{ascending:!0}).limit(5e3),d.N.from("product_variants").select("id,product_id,label,sku,stock,products:products(id,name,slug)").order("id",{ascending:!0}).limit(5e3),d.N.from("inventory_batches").select("id,variant_id,supplier_id,qty_received,qty_remaining,total_cost,paid_amount,payment_method,reference,received_at,note").order("received_at",{ascending:!1}).limit(2e3),d.N.from("inventory_movements").select("id,variant_id,batch_id,type,qty,note,order_id,created_at").order("created_at",{ascending:!1}).limit(3e3)]);if(s.error)throw s.error;if(a.error)throw a.error;if(l.error)throw l.error;if(i.error)throw i.error;if(!e)return;x(s.data??[]),h(a.data??[]),b(l.data??[]),j(i.data??[])}catch(t){if(!e)return;r(t?.message||"Failed to load suppliers")}finally{e&&t(!1)}})(),()=>{e=!1}},[]);let q=(0,i.useMemo)(()=>{let e={};for(let t of o)e[t.id]=t;return e},[o]),O=(0,i.useMemo)(()=>{let e={};for(let t of u)e[t.id]=t;return e},[u]),z=(0,i.useMemo)(()=>p.filter(e=>n(e.total_cost)-n(e.paid_amount)>1e-4).slice(0,300),[p]),A=(0,i.useMemo)(()=>{let e=y.trim().toLowerCase();return e?o.filter(t=>`${t.name} ${t.phone??""} ${t.email??""}`.toLowerCase().includes(e)):o},[o,y]),J=v?q[v]:null,Z=(0,i.useMemo)(()=>v?p.filter(e=>Number(e.supplier_id)===Number(v)):[],[p,v]),B=(0,i.useMemo)(()=>Z.filter(e=>n(e.total_cost)-n(e.paid_amount)>1e-4),[Z]),H=(0,i.useMemo)(()=>{if(!v)return[];let e={};for(let t of Z){let s=O[Number(t.variant_id)];if(!s)continue;let a=s.products?.name??`Product #${s.product_id}`,r=Number(s.id);e[r]=e[r]||{variantId:s.id,productName:a,variantLabel:s.label,sku:s.sku,times:0},e[r].times+=1}return Object.values(e).sort((e,t)=>t.times-e.times)},[Z,v,O]),T=(0,i.useMemo)(()=>{if(!v)return[];let e=new Set(Z.map(e=>Number(e.id)));return N.filter(t=>t.batch_id&&e.has(Number(t.batch_id))).slice(0,200)},[N,Z,v]),V=(0,i.useMemo)(()=>{let e=z.reduce((e,t)=>e+Math.max(0,n(t.total_cost)-n(t.paid_amount)),0);return{suppliers:o.length,unpaidCount:z.length,totalUnpaid:e}},[o.length,z]);async function D(){if(!S)return void r("No batch selected for payment.");let e=n(k),t=Math.max(0,n(S.total_cost)-n(S.paid_amount));if(e<=0)return void r("Payment amount must be greater than zero.");if(e>t+1e-4)return void r("Payment amount cannot exceed amount due.");U(!0),r(null);try{let{error:t}=await d.N.from("inventory_payments").insert({batch_id:S.id,amount:e,method:I,reference:$||null});if(t)throw t;let s=n(S.paid_amount)+e,{error:a}=await d.N.from("inventory_batches").update({paid_amount:s,payment_method:I,reference:$||S.reference||null}).eq("id",S.id);if(a)throw a;b(e=>e.map(e=>e.id===S.id?{...e,paid_amount:s,payment_method:I,reference:$||S.reference||null}:e)),w(!1),C(null),M(""),P("EVC"),E("")}catch(e){r(e?.message||"Failed to submit payment")}finally{U(!1)}}return(0,a.jsxs)("main",{className:"min-h-screen bg-gray-50 text-black",children:[(0,a.jsxs)("div",{className:"max-w-7xl mx-auto px-4 py-6",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(l(),{href:"/admin",className:"text-sm text-blue-600 hover:underline",children:"← Admin"}),(0,a.jsx)("h1",{className:"text-xl font-semibold mt-2",children:"Suppliers"}),(0,a.jsx)("p",{className:"text-xs text-gray-600 mt-1",children:"See supplier list, unpaid invoices (Pay later), and what each supplier brings."})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-600 text-right",children:["Suppliers: ",(0,a.jsx)("span",{className:"font-semibold",children:e?"…":V.suppliers}),(0,a.jsx)("br",{}),"Unpaid invoices: ",(0,a.jsx)("span",{className:"font-semibold",children:e?"…":V.unpaidCount})," • Total due:"," ",(0,a.jsx)("span",{className:"font-semibold",children:e?"…":c(V.totalUnpaid)})]})]}),s?(0,a.jsx)("div",{className:"mt-4 border rounded-2xl p-4 bg-white text-sm text-red-600",children:s}):null,(0,a.jsxs)("section",{className:"mt-4 grid grid-cols-2 lg:grid-cols-4 gap-3",children:[(0,a.jsxs)("div",{className:"border rounded-2xl p-4 bg-white",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Unpaid invoices"}),(0,a.jsx)("div",{className:"mt-1 text-lg font-semibold",children:e?"…":V.unpaidCount})]}),(0,a.jsxs)("div",{className:"border rounded-2xl p-4 bg-white",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Total due"}),(0,a.jsx)("div",{className:"mt-1 text-lg font-semibold",children:e?"…":c(V.totalUnpaid)})]})]}),(0,a.jsxs)("div",{className:"mt-4 grid grid-cols-1 lg:grid-cols-[1fr_1.4fr] gap-3",children:[(0,a.jsxs)("section",{className:"border rounded-2xl bg-white p-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,a.jsx)("div",{className:"font-semibold",children:"Supplier list"}),(0,a.jsx)("input",{value:y,onChange:e=>f(e.target.value),placeholder:"Search supplier…",className:"w-[220px] max-w-full border rounded-full px-4 py-2 text-sm"})]}),(0,a.jsx)("div",{className:"mt-3 space-y-2",children:(e?Array.from({length:8}):A).map((t,s)=>{if(e)return(0,a.jsx)("div",{className:"h-12 bg-gray-100 rounded-xl"},s);let r=Number(t.id)===Number(v);return(0,a.jsxs)("button",{onClick:()=>g(Number(t.id)),className:`w-full text-left border rounded-xl p-3 hover:bg-gray-50 ${r?"border-blue-600":""}`,children:[(0,a.jsx)("div",{className:"text-sm font-semibold",children:t.name}),(0,a.jsxs)("div",{className:"text-xs text-gray-600 mt-1",children:[t.phone?t.phone:""," ",t.email?`• ${t.email}`:""]})]},t.id)})})]}),(0,a.jsx)("section",{className:"border rounded-2xl bg-white p-4",children:J?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"Supplier"}),(0,a.jsx)("div",{className:"text-lg font-semibold",children:J.name}),(0,a.jsxs)("div",{className:"text-xs text-gray-600 mt-1",children:[J.phone?J.phone:"",J.address?` • ${J.address}`:""]})]}),(0,a.jsxs)("div",{className:"text-right text-xs text-gray-600",children:["Unpaid: ",(0,a.jsx)("span",{className:"font-semibold",children:B.length})]})]}),(0,a.jsxs)("div",{className:"mt-4 border rounded-2xl p-3 bg-yellow-50",children:[(0,a.jsx)("div",{className:"font-semibold text-sm",children:"Unpaid invoices"}),0===B.length?(0,a.jsx)("div",{className:"mt-2 text-sm text-gray-600",children:"No unpaid invoices."}):(0,a.jsx)("div",{className:"mt-2 space-y-2",children:B.slice(0,20).map(e=>{let t=Math.max(0,n(e.total_cost)-n(e.paid_amount)),s=O[Number(e.variant_id)],r=s?.products?.name??"Product";return(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,a.jsxs)("div",{className:"text-gray-700",children:["Batch #",e.id," • ",r,e.reference?` • ${e.reference}`:""]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"font-semibold",children:c(t)}),(0,a.jsx)("button",{onClick:()=>{let t;return t=Math.max(0,n(e.total_cost)-n(e.paid_amount)),void(C(e),M(t>0?String(t):""),P("EVC"),E(""),w(!0))},className:"px-3 py-1 rounded-full border bg-white text-xs font-semibold hover:bg-gray-50",children:"Pay / Partial"})]})]},e.id)})})]}),(0,a.jsxs)("div",{className:"mt-4 border rounded-2xl p-3",children:[(0,a.jsx)("div",{className:"font-semibold text-sm",children:"Products supplied"}),0===H.length?(0,a.jsx)("div",{className:"mt-2 text-sm text-gray-600",children:"No batches found for this supplier."}):(0,a.jsx)("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2",children:H.slice(0,24).map(e=>(0,a.jsxs)("div",{className:"border rounded-xl p-2",children:[(0,a.jsx)("div",{className:"text-sm font-semibold",children:e.productName}),(0,a.jsxs)("div",{className:"text-xs text-gray-600 mt-1",children:[e.variantLabel," • SKU:",e.sku]}),(0,a.jsxs)("div",{className:"text-xs text-gray-600 mt-1",children:["Delivered batches: ",(0,a.jsx)("span",{className:"font-semibold",children:e.times})]})]},e.variantId))})]}),(0,a.jsxs)("div",{className:"mt-4 border rounded-2xl p-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,a.jsx)("div",{className:"font-semibold text-sm",children:"Supply history"}),(0,a.jsxs)("div",{className:"text-xs text-gray-600",children:["Total deliveries: ",(0,a.jsx)("span",{className:"font-semibold",children:Z.length})]})]}),0===Z.length?(0,a.jsx)("div",{className:"mt-2 text-sm text-gray-600",children:"No deliveries recorded for this supplier."}):(0,a.jsxs)("div",{className:"mt-3 overflow-x-auto",children:[(0,a.jsxs)("table",{className:"w-full text-sm",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"text-left text-xs text-gray-500 border-b",children:[(0,a.jsx)("th",{className:"py-2 pr-3",children:"Date"}),(0,a.jsx)("th",{className:"py-2 pr-3",children:"Product"}),(0,a.jsx)("th",{className:"py-2 pr-3",children:"Qty"}),(0,a.jsx)("th",{className:"py-2 pr-3",children:"Total cost"}),(0,a.jsx)("th",{className:"py-2 pr-3",children:"Paid"}),(0,a.jsx)("th",{className:"py-2 pr-3",children:"Due"}),(0,a.jsx)("th",{className:"py-2 pr-3",children:"Note"})]})}),(0,a.jsx)("tbody",{children:Z.slice(0,50).map(e=>{let t=O[Number(e.variant_id)],s=t?.products?.name??"Product",r=t?.label?` (${t.label})`:"",l=Math.max(0,n(e.total_cost)-n(e.paid_amount));return(0,a.jsxs)("tr",{className:"border-b last:border-b-0",children:[(0,a.jsx)("td",{className:"py-2 pr-3 whitespace-nowrap text-xs text-gray-600",children:String(e.received_at)}),(0,a.jsxs)("td",{className:"py-2 pr-3",children:[(0,a.jsxs)("div",{className:"font-semibold text-gray-900",children:[s,r]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["Batch #",e.id,e.reference?` • ${e.reference}`:""]})]}),(0,a.jsx)("td",{className:"py-2 pr-3 whitespace-nowrap",children:n(e.qty_received)}),(0,a.jsx)("td",{className:"py-2 pr-3 whitespace-nowrap",children:c(e.total_cost)}),(0,a.jsx)("td",{className:"py-2 pr-3 whitespace-nowrap",children:c(e.paid_amount)}),(0,a.jsx)("td",{className:"py-2 pr-3 whitespace-nowrap",children:(0,a.jsx)("span",{className:l>0?"font-semibold text-amber-700":"text-gray-600",children:c(l)})}),(0,a.jsx)("td",{className:"py-2 pr-3 text-xs text-gray-600",children:e.note??""})]},e.id)})})]}),Z.length>50?(0,a.jsx)("div",{className:"mt-2 text-xs text-gray-500",children:"Showing latest 50 deliveries. (Add pagination later if you want.)"}):null]})]}),(0,a.jsxs)("div",{className:"mt-4 border rounded-2xl p-3",children:[(0,a.jsx)("div",{className:"font-semibold text-sm",children:"Inventory movements (from this supplier’s batches)"}),0===T.length?(0,a.jsx)("div",{className:"mt-2 text-sm text-gray-600",children:"No movements found."}):(0,a.jsx)("div",{className:"mt-2 space-y-2 text-sm",children:T.slice(0,40).map(e=>(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsxs)("div",{className:"text-gray-700",children:[e.type," ",(0,a.jsx)("span",{className:"font-semibold",children:e.qty>0?`+${e.qty}`:e.qty}),(0,a.jsxs)("span",{className:"text-xs text-gray-500",children:[e.batch_id?` • batch #${e.batch_id}`:"",e.order_id?` • order #${e.order_id}`:"",e.note?` • ${e.note}`:""]})]}),(0,a.jsx)("div",{className:"text-xs text-gray-500",children:String(e.created_at)})]},e.id))})]})]}):(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"Select a supplier to view invoices and items."})})]})]}),_&&S?(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40",onClick:()=>{w(!1),C(null)},children:(0,a.jsxs)("div",{className:"bg-white rounded-xl p-6 max-w-md w-full",onClick:e=>e.stopPropagation(),role:"dialog","aria-modal":"true","aria-labelledby":"pay-modal-title",children:[(0,a.jsx)("h2",{id:"pay-modal-title",className:"text-lg font-semibold mb-2",children:"Pay supplier invoice"}),(0,a.jsxs)("p",{className:"text-sm text-gray-600 mb-4",children:["Batch #",S.id," •"," ",O[S.variant_id]?.products?.name??`Product #${O[S.variant_id]?.product_id}`]}),(0,a.jsxs)("p",{className:"mb-4",children:["Due: ",(0,a.jsx)("span",{className:"font-semibold",children:c(Math.max(0,n(S.total_cost)-n(S.paid_amount)))})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"pay-amount",className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount"}),(0,a.jsx)("input",{id:"pay-amount",type:"number",step:"0.01",min:"0",max:Math.max(0,n(S.total_cost)-n(S.paid_amount)),value:k,onChange:e=>M(e.target.value),className:"w-full border rounded px-3 py-2"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"pay-method",className:"block text-sm font-medium text-gray-700 mb-1",children:"Method"}),(0,a.jsx)("select",{id:"pay-method",value:I,onChange:e=>P(e.target.value),className:"w-full border rounded px-3 py-2",children:m.map(e=>(0,a.jsx)("option",{value:e,children:e},e))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"pay-ref",className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference"}),(0,a.jsx)("input",{id:"pay-ref",type:"text",value:$,onChange:e=>E(e.target.value),className:"w-full border rounded px-3 py-2"})]})]}),(0,a.jsxs)("div",{className:"mt-6 flex justify-end gap-3",children:[(0,a.jsx)("button",{type:"button",onClick:()=>{w(!1),C(null)},className:"px-4 py-2 rounded border bg-gray-100 hover:bg-gray-200",disabled:F,children:"Cancel"}),(0,a.jsx)("button",{type:"button",onClick:D,disabled:F,className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50",children:F?"Saving...":"Save"})]})]})}):null]})}},4859:(e,t,s)=>{Promise.resolve().then(s.bind(s,2649))}},e=>{e.O(0,[500,958,441,794,358],()=>e(e.s=4859)),_N_E=e.O()}]);