(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[417],{117:(e,t,s)=>{"use strict";s.d(t,{N:()=>a});let a=(0,s(1958).UU)("https://ecfxrmhrfjqdmqewzrfz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjZnhybWhyZmpxZG1xZXd6cmZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDA0OTgsImV4cCI6MjA4MTkxNjQ5OH0.jtF3Qp9N7rH-KCWEMHU0atH7h-LQEJBKYO9Q2HdxkX0")},2259:(e,t,s)=>{Promise.resolve().then(s.bind(s,6265))},6265:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var a=s(5155),r=s(8500),i=s.n(r),l=s(2115),n=s(117);function d(e){let t=Number(e??0);return new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(Number.isFinite(t)?t:0)}function m(e){let t=Number(e??0);return Number.isFinite(t)?t:0}function c(){let[e,t]=(0,l.useState)(!0),[s,r]=(0,l.useState)(null),[c,o]=(0,l.useState)(null),[x,u]=(0,l.useState)([]),[h,p]=(0,l.useState)([]),[N,f]=(0,l.useState)(null),[g,b]=(0,l.useState)(!1),[j,y]=(0,l.useState)(null),[v,E]=(0,l.useState)([]);async function _(){t(!0),o(null);try{let[{data:e,error:t},{data:s,error:a}]=await Promise.all([n.N.from("orders").select("id,created_at,status,total_amount,delivery_name,delivery_phone").order("created_at",{ascending:!1}).limit(200),n.N.from("payments").select("id,order_id,amount,status,method,created_at,reference").order("created_at",{ascending:!1}).limit(2e3)]);if(t)throw t;if(a)throw a;u(e??[]),p(s??[])}catch(e){o(e?.message||"Failed to load orders")}finally{t(!1)}}(0,l.useEffect)(()=>{let e=!0;return(async()=>{if(await _(),!e)return})(),()=>{e=!1}},[]);let A=(0,l.useMemo)(()=>{let e=new Map;for(let t of h){let s=Number(t.order_id);s&&"SUCCESS"===String(t.status||"").toUpperCase()&&e.set(s,(e.get(s)??0)+m(t.amount))}return e},[h]),w=(0,l.useMemo)(()=>x.map(e=>{let t=m(e.total_amount),s=A.get(Number(e.id))??0,a=Math.max(0,t-s);return{...e,total:t,paid:s,remaining:a,computedStatus:a>0?"PENDING":"PAID"}}),[x,A]),S=(0,l.useMemo)(()=>{let e=w.filter(e=>"PENDING"===e.computedStatus).length;return{pending:e,total:w.reduce((e,t)=>e+t.total,0),outstanding:w.reduce((e,t)=>e+t.remaining,0)}},[w]),C=(0,l.useMemo)(()=>{let e=new Map;for(let t of h){let s=Number(t.order_id);s&&(e.has(s)||e.set(s,[]),e.get(s).push(t))}for(let[t,s]of e.entries())s.sort((e,t)=>String(t.created_at).localeCompare(String(e.created_at))),e.set(t,s);return e},[h]);async function I(e){let t=`ORDPAY-${e.orderId}-${Date.now()}-${Math.random().toString(16).slice(2)}`,s=await n.N.from("payments").insert({order_id:e.orderId,method:e.method,amount:e.amount,status:"SUCCESS",reference:t});if(s.error)throw s.error}async function P(e,t){let s=await n.N.from("orders").update({status:t}).eq("id",e);if(s.error)throw s.error}async function M(e,t){if(e.remaining<=0)return;let s=function(){let e,t=window.prompt("Payment method? Type: EVC, EDAHAB, MERCHANT, CASH, PREMIER_BANK","EVC");if(!t)return null;let s="EVC"===(e=t.trim().toUpperCase())?"EVC":"EDAHAB"===e||"E-DAHAB"===e||"EDAHAB+"===e||"EDAHAAB"===e?"EDAHAB":"MERCHANT"===e?"MERCHANT":"CASH"===e?"CASH":"PREMIER_BANK"===e||"PREMIER"===e||"BANK"===e?"PREMIER_BANK":null;return s||(alert("Invalid method. Use: EVC, EDAHAB, MERCHANT, CASH, PREMIER_BANK"),null)}();if(!s)return;let a=e.remaining;if("PARTIAL"===t){let t=window.prompt(`Enter amount to pay (remaining: ${d(e.remaining)})`,"");if(!t)return;if((a=m(t))<=0)return alert("Amount must be > 0");if(a>e.remaining)return alert("Amount cannot exceed remaining")}try{r(e.id),await I({orderId:e.id,amount:a,method:s});let t=Math.max(0,e.remaining-a);await P(e.id,t>0?"PENDING":"PAID"),await _(),N===e.id&&await R(e.id)}catch(e){console.error(e),alert(e?.message||"Payment failed")}finally{r(null)}}async function R(e){f(e),b(!0),y(null),E([]);try{let{data:t,error:s}=await n.N.from("order_items").select(`
          id, order_id, quantity, price_at_purchase, variant_id, product_id,
          variant:product_variants (
            id, label,
            product:products ( id, name )
          )
        `).eq("order_id",e).order("id",{ascending:!0});if(s)throw s;E(t??[])}catch(e){y(e?.message||"Failed to load order items")}finally{b(!1)}}let k=(0,l.useMemo)(()=>null==N?null:w.find(e=>Number(e.id)===Number(N))??null,[N,w]),H=(0,l.useMemo)(()=>null==N?[]:C.get(N)??[],[N,C]),D=(0,l.useMemo)(()=>v.reduce((e,t)=>e+m(t.price_at_purchase)*m(t.quantity),0),[v]);return(0,a.jsxs)("main",{className:"min-h-screen bg-gray-50 text-black",children:[(0,a.jsxs)("div",{className:"max-w-6xl mx-auto px-4 py-6",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(i(),{href:"/admin",className:"text-sm text-blue-600 hover:underline",children:"← Admin"}),(0,a.jsx)("h1",{className:"text-xl font-semibold mt-2",children:"Orders"}),(0,a.jsx)("p",{className:"text-xs text-gray-600 mt-1",children:"Status here is computed from payments: Total − SUCCESS payments."})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-700 border bg-white rounded-2xl px-3 py-2",children:[(0,a.jsxs)("div",{children:["Pending(credit): ",(0,a.jsx)("span",{className:"font-semibold",children:e?"…":S.pending})]}),(0,a.jsxs)("div",{children:["Outstanding: ",(0,a.jsx)("span",{className:"font-semibold",children:e?"…":d(S.outstanding)})]}),(0,a.jsxs)("div",{children:["Total(loaded): ",(0,a.jsx)("span",{className:"font-semibold",children:e?"…":d(S.total)})]})]})]}),(0,a.jsx)("div",{className:"mt-3 flex items-center gap-2",children:(0,a.jsx)("button",{onClick:_,className:"px-4 py-2 rounded-full border bg-white text-sm font-semibold",disabled:e,children:e?"Refreshing…":"Refresh"})}),c?(0,a.jsx)("div",{className:"mt-4 border rounded-2xl p-4 bg-white text-sm text-red-600",children:c}):null,(0,a.jsx)("section",{className:"mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3",children:(e?Array.from({length:8}):w).map((e,t)=>(0,a.jsxs)("div",{className:"border rounded-2xl p-4 bg-white cursor-pointer",onClick:()=>e?.id?R(Number(e.id)):null,role:"button",tabIndex:0,onKeyDown:t=>{"Enter"===t.key&&e?.id&&R(Number(e.id))},children:[(0,a.jsxs)("div",{className:"flex justify-between gap-3",children:[(0,a.jsxs)("div",{className:"text-sm font-semibold",children:["Order #",e?.id??"…"]}),(0,a.jsx)("div",{className:"text-xs text-gray-600",children:e?.created_at?String(e.created_at):"…"})]}),(0,a.jsxs)("div",{className:"mt-2 text-sm",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Status:"})," ",(0,a.jsx)("span",{className:`font-semibold ${e?.computedStatus==="PENDING"?"text-orange-700":"text-green-700"}`,children:e?.computedStatus??"…"})]}),(0,a.jsxs)("div",{className:"mt-2 text-sm flex flex-wrap gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Total:"})," ",(0,a.jsx)("span",{className:"font-semibold",children:d(e?.total)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Paid:"})," ",(0,a.jsx)("span",{className:"font-semibold",children:d(e?.paid)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Remaining:"})," ",(0,a.jsx)("span",{className:"font-semibold",children:d(e?.remaining)})]})]}),(0,a.jsxs)("div",{className:"mt-2 text-xs text-gray-600",children:[e?.delivery_name??""," ",e?.delivery_phone?`• ${e.delivery_phone}`:""]}),e?.computedStatus==="PENDING"?(0,a.jsxs)("div",{className:"mt-3 flex gap-2",onClick:e=>e.stopPropagation(),children:[(0,a.jsx)("button",{onClick:()=>M(e,"FULL"),disabled:null!=s,className:"px-4 py-2 rounded-full bg-green-600 text-white text-sm font-semibold disabled:opacity-60",children:s===e.id?"Working…":"Mark Paid"}),(0,a.jsx)("button",{onClick:()=>M(e,"PARTIAL"),disabled:null!=s,className:"px-4 py-2 rounded-full border text-sm font-semibold disabled:opacity-60",children:s===e.id?"Working…":"Pay partial"})]}):(0,a.jsx)("div",{className:"mt-3 text-xs text-green-700 font-semibold",children:"Paid"}),(0,a.jsx)("div",{className:"mt-2 text-[11px] text-gray-500",children:"Tap to view items"})]},e?.id??t))})]}),null!=N?(0,a.jsx)("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-end sm:items-center justify-center p-3",children:(0,a.jsxs)("div",{className:"w-full sm:max-w-2xl bg-white rounded-2xl border shadow-lg overflow-hidden",children:[(0,a.jsxs)("div",{className:"p-4 border-b flex items-start justify-between gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"text-sm font-semibold",children:["Order #",k?.id??N]}),(0,a.jsxs)("div",{className:"text-xs text-gray-600 mt-1",children:[k?.delivery_name??""," ",k?.delivery_phone?`• ${k.delivery_phone}`:""]}),(0,a.jsxs)("div",{className:"text-xs text-gray-600 mt-1",children:["Status: ",(0,a.jsx)("span",{className:"font-semibold",children:k?.computedStatus??"…"}),k?(0,a.jsxs)(a.Fragment,{children:[" ","• Remaining: ",(0,a.jsx)("span",{className:"font-semibold",children:d(k.remaining)})]}):null]})]}),(0,a.jsx)("button",{className:"px-3 py-2 rounded-full border text-sm font-semibold",onClick:()=>f(null),children:"Close"})]}),(0,a.jsxs)("div",{className:"p-4",children:[j?(0,a.jsx)("div",{className:"mb-3 border rounded-xl p-3 text-sm text-red-600",children:j}):null,(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[(0,a.jsxs)("div",{className:"border rounded-2xl p-3",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Items"}),g?(0,a.jsx)("div",{className:"mt-2 text-sm text-gray-600",children:"Loading…"}):0===v.length?(0,a.jsx)("div",{className:"mt-2 text-sm text-gray-600",children:"No items found."}):(0,a.jsxs)("div",{className:"mt-2 space-y-2",children:[v.map(e=>{let t=e.variant?.product?.name||(e.product_id?`Product #${e.product_id}`:`Item #${e.id}`),s=e.variant?.label?` (${e.variant.label})`:"",r=m(e.price_at_purchase)*m(e.quantity);return(0,a.jsxs)("div",{className:"text-sm flex justify-between gap-3",children:[(0,a.jsxs)("div",{className:"text-gray-800",children:[t,s," \xd7 ",e.quantity]}),(0,a.jsx)("div",{className:"font-semibold",children:d(r)})]},e.id)}),(0,a.jsxs)("div",{className:"pt-2 mt-2 border-t flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"font-semibold",children:"Items total"}),(0,a.jsx)("span",{className:"font-semibold",children:d(D)})]})]})]}),(0,a.jsxs)("div",{className:"border rounded-2xl p-3",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Payments"}),(0,a.jsx)("div",{className:"mt-2 space-y-2",children:0===H.length?(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"No payments yet."}):H.map((e,t)=>(0,a.jsxs)("div",{className:"text-sm flex justify-between gap-3",children:[(0,a.jsxs)("div",{className:"text-gray-800",children:[String(e.method)," • ",String(e.status),(0,a.jsx)("div",{className:"text-[11px] text-gray-500",children:String(e.created_at)})]}),(0,a.jsx)("div",{className:"font-semibold",children:d(e.amount)})]},e?.id??`${e.order_id}-${t}`))}),k?.computedStatus==="PENDING"?(0,a.jsxs)("div",{className:"mt-3 flex gap-2",children:[(0,a.jsx)("button",{onClick:()=>k?M(k,"FULL"):null,disabled:null!=s,className:"px-4 py-2 rounded-full bg-green-600 text-white text-sm font-semibold disabled:opacity-60",children:s===k?.id?"Working…":"Mark Paid"}),(0,a.jsx)("button",{onClick:()=>k?M(k,"PARTIAL"):null,disabled:null!=s,className:"px-4 py-2 rounded-full border text-sm font-semibold disabled:opacity-60",children:s===k?.id?"Working…":"Pay partial"})]}):(0,a.jsx)("div",{className:"mt-3 text-xs text-green-700 font-semibold",children:"Paid"}),(0,a.jsx)("div",{className:"mt-2 text-[11px] text-gray-500",children:"Methods supported here: EVC, EDAHAB, MERCHANT, CASH, PREMIER_BANK"})]})]})]})]})}):null]})}}},e=>{e.O(0,[500,958,441,794,358],()=>e(e.s=2259)),_N_E=e.O()}]);