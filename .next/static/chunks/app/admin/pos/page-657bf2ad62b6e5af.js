(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2667],{117:(e,t,r)=>{"use strict";r.d(t,{N:()=>i});let i=(0,r(1958).UU)("https://ecfxrmhrfjqdmqewzrfz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjZnhybWhyZmpxZG1xZXd6cmZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDA0OTgsImV4cCI6MjA4MTkxNjQ5OH0.jtF3Qp9N7rH-KCWEMHU0atH7h-LQEJBKYO9Q2HdxkX0")},546:(e,t,r)=>{Promise.resolve().then(r.bind(r,7190))},7190:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>u});var i=r(5155),a=r(8500),s=r.n(a),n=r(2115),l=r(117),o=r(7270);let d=e=>Number.isFinite(Number(e))?Number(e):0,c=e=>`\xa3${Number(e??0).toFixed(2)}`;function u(){let[e,t]=(0,n.useState)(!0),[r,a]=(0,n.useState)(!1),[u,m]=(0,n.useState)([]),[f,h]=(0,n.useState)([]),[x,p]=(0,n.useState)(""),[y,g]=(0,n.useState)(""),[N,b]=(0,n.useState)(""),[v,w]=(0,n.useState)(""),[_,j]=(0,n.useState)(""),[S,C]=(0,n.useState)(""),[I,k]=(0,n.useState)("EVC"),[E,q]=(0,n.useState)([]);(0,n.useEffect)(()=>{let e=!0;return(async()=>{t(!0);try{let[t,r]=await Promise.all([(0,o.eN)(),(0,o.Xo)()]);if(!e)return;m(t.filter(e=>!1!==e.is_active)),h(r)}finally{e&&t(!1)}})(),()=>{e=!1}},[]);let A=(0,n.useMemo)(()=>{let e=x.trim().toLowerCase();return e?u.filter(t=>t.name.toLowerCase().includes(e)).slice(0,50):u.slice(0,50)},[x,u]),R=(0,n.useMemo)(()=>y?f.filter(e=>e.product_id===y):[],[f,y]),M=(0,n.useMemo)(()=>E.reduce((e,t)=>e+t.qty*t.price,0),[E]);function O(e,t){q(r=>r.map(r=>r.key===e?{...r,qty:Math.max(1,t)}:r).filter(e=>e.qty>0))}async function $(){let e=String(_??"").trim(),t=String(v??"").trim()||"Customer";if(!e)return null;let r=await l.N.from("customers").select("id").eq("phone",e).maybeSingle();if(r.error)throw r.error;if(r.data?.id)return Number(r.data.id);let i=await l.N.from("customers").insert({name:t,phone:e}).select("id").single();if(i.error)throw i.error;return Number(i.data.id)}async function P(){if(0===E.length)return alert("Add at least 1 item.");a(!0);try{let e=await $(),t="CREDIT"===I,r=await l.N.from("orders").insert({customer_id:e,total_amount:M,status:t?"PENDING":"PAID",delivery_name:v||null,delivery_phone:_||null,delivery_address:"MATO Minmart",delivery_note:S||null}).select("id").single();if(r.error)throw r.error;let i=Number(r.data.id),a=E.map(e=>({order_id:i,product_id:e.productId,variant_id:e.variantId,quantity:e.qty,price_at_purchase:e.price})),s=await l.N.from("order_items").insert(a);if(s.error)throw s.error;if(!t){let e=await l.N.from("payments").insert({order_id:i,method:I,amount:M,status:"SUCCESS",reference:`POS-${i}-${Date.now()}`});if(e.error)throw e.error}q([]),g(""),b(""),w(""),j(""),C(""),k("EVC"),alert("Sale saved ✅")}catch(e){console.error(e),alert(e?.message||"Failed to save sale")}finally{a(!1)}}return(0,i.jsx)("main",{className:"min-h-screen bg-white text-black",children:(0,i.jsxs)("div",{className:"max-w-6xl mx-auto px-4 py-6",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h1",{className:"text-xl font-semibold",children:"Fast Sale (Admin POS)"}),(0,i.jsx)("p",{className:"text-sm text-gray-600",children:"Quick sale + credit orders for your shop staff."})]}),(0,i.jsx)(s(),{href:"/admin",className:"text-sm text-blue-600 hover:underline",children:"← Back"})]}),(0,i.jsxs)("div",{className:"mt-5 grid grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,i.jsxs)("section",{className:"border rounded-2xl p-4 col-span-2 lg:col-span-2",children:[(0,i.jsx)("div",{className:"font-semibold",children:"Add items"}),(0,i.jsx)("input",{className:"mt-3 w-full border rounded-xl px-3 py-2 text-sm",placeholder:"Search product…",value:x,onChange:e=>p(e.target.value)}),(0,i.jsxs)("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,i.jsxs)("select",{className:"border rounded-xl px-3 py-2 text-sm",value:y,onChange:e=>{let t=e.target.value;g(t?Number(t):""),b("")},disabled:e,children:[(0,i.jsx)("option",{value:"",children:"Select product…"}),A.map(e=>(0,i.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,i.jsxs)("select",{className:"border rounded-xl px-3 py-2 text-sm",value:N,onChange:e=>b(e.target.value?Number(e.target.value):""),disabled:!y,children:[(0,i.jsx)("option",{value:"",children:"Select variant…"}),R.map(e=>(0,i.jsxs)("option",{value:e.id,children:[e.label," • ",c(d(e.price))," • stock ",e.stock]},e.id))]})]}),(0,i.jsx)("button",{onClick:function(){if(!y||!N)return;let e=u.find(e=>e.id===y),t=f.find(e=>e.id===N);if(!e||!t)return;let r=`${e.id}-${t.id}`,i=d(t.price);q(a=>{let s=a.findIndex(e=>e.key===r);if(s>=0){let e=[...a];return e[s]={...e[s],qty:e[s].qty+1},e}return[...a,{key:r,productId:e.id,variantId:t.id,name:`${e.name} (${t.label})`,qty:1,price:i}]})},disabled:!y||!N,className:`mt-3 w-full rounded-full py-2 text-sm font-semibold ${!y||!N?"bg-gray-200 text-gray-500":"bg-black text-white"}`,children:"Add"}),(0,i.jsx)("div",{className:"mt-6 font-semibold",children:"Customer"}),(0,i.jsxs)("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,i.jsx)("input",{className:"border rounded-xl px-3 py-2 text-sm",placeholder:"Name (optional)",value:v,onChange:e=>w(e.target.value)}),(0,i.jsx)("input",{className:"border rounded-xl px-3 py-2 text-sm",placeholder:"Phone (Somalia)",value:_,onChange:e=>j(e.target.value)})]}),(0,i.jsx)("textarea",{className:"mt-3 border rounded-xl px-3 py-2 text-sm w-full",rows:2,placeholder:"Note (optional)",value:S,onChange:e=>C(e.target.value)}),(0,i.jsx)("div",{className:"mt-4 font-semibold",children:"Payment"}),(0,i.jsx)("div",{className:"mt-2 grid grid-cols-4 gap-2",children:["EVC","CASH","MERCHANT","CREDIT"].map(e=>(0,i.jsx)("button",{onClick:()=>k(e),className:`rounded-xl border py-2 text-xs font-semibold ${I===e?"bg-blue-600 text-white border-blue-600":"bg-white"}`,children:e},e))})]}),(0,i.jsxs)("aside",{className:"border rounded-2xl p-4 col-span-2 lg:col-span-2",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)("div",{className:"font-semibold",children:"Sale"}),(0,i.jsx)("div",{className:"text-sm font-semibold",children:c(M)})]}),(0,i.jsx)("div",{className:"mt-3 space-y-2",children:0===E.length?(0,i.jsx)("div",{className:"text-sm text-gray-600",children:"No items."}):E.map(e=>(0,i.jsxs)("div",{className:"border rounded-2xl p-3",children:[(0,i.jsxs)("div",{className:"flex justify-between gap-2",children:[(0,i.jsxs)("div",{className:"min-w-0",children:[(0,i.jsx)("div",{className:"text-sm font-semibold",children:e.name}),(0,i.jsxs)("div",{className:"text-xs text-gray-600",children:[c(e.price)," • line ",c(e.price*e.qty)]})]}),(0,i.jsx)("button",{className:"text-xs text-red-600",onClick:()=>{var t;return t=e.key,void q(e=>e.filter(e=>e.key!==t))},children:"Remove"})]}),(0,i.jsxs)("div",{className:"mt-2 flex items-center gap-2",children:[(0,i.jsx)("button",{className:"h-9 w-9 rounded-xl border",onClick:()=>O(e.key,e.qty-1),children:"−"}),(0,i.jsx)("input",{className:"h-9 w-16 border rounded-xl text-center text-sm",value:e.qty,onChange:t=>O(e.key,Number(t.target.value||1))}),(0,i.jsx)("button",{className:"h-9 w-9 rounded-xl border",onClick:()=>O(e.key,e.qty+1),children:"+"})]})]},e.key))}),(0,i.jsx)("button",{onClick:P,disabled:r||0===E.length,className:`mt-4 w-full rounded-full py-3 text-sm font-semibold ${r||0===E.length?"bg-gray-200 text-gray-500":"bg-green-600 text-white"}`,children:r?"Saving…":`Complete • ${c(M)}`}),(0,i.jsx)("p",{className:"mt-2 text-xs text-gray-500",children:"CREDIT saves order as PENDING (no payment row). EVC/CASH/MERCHANT saves PAID + payment SUCCESS."})]})]})]})})}},7270:(e,t,r)=>{"use strict";r.d(t,{Cd:()=>x,HZ:()=>v,J:()=>m,TW:()=>y,Tl:()=>f,VR:()=>s,Xo:()=>d,cg:()=>N,dC:()=>u,eN:()=>o,fS:()=>b,hB:()=>c,iV:()=>n,ii:()=>l,lN:()=>a,lv:()=>g,ob:()=>h,wR:()=>p});var i=r(117);function a(e){let t=String(e??"").trim();return t&&(t.startsWith("/")||t.startsWith("http://")||t.startsWith("https://"))?t:"/example.png"}async function s(){let{data:e,error:t}=await i.N.from("categories").select("id,slug,img,name_so,name_en").order("id",{ascending:!0});if(t)throw t;let{data:r,error:a}=await i.N.from("subcategories").select("id,category_id,slug,img,name_so,name_en").order("id",{ascending:!0});if(a)throw a;let s=r??[];return(e??[]).map(e=>({...e,subcats:s.filter(t=>t.category_id===e.id)}))}async function n(){let{data:e,error:t}=await i.N.from("categories").select("*").order("id");if(t)throw t;return e??[]}async function l(){let{data:e,error:t}=await i.N.from("subcategories").select("*").order("id");if(t)throw t;return e??[]}async function o(){let{data:e,error:t}=await i.N.from("products").select("*").order("id");if(t)throw t;return e??[]}async function d(){let{data:e,error:t}=await i.N.from("product_variants").select("*").order("id");if(t)throw t;return e??[]}async function c(){let{data:e,error:t}=await i.N.from("product_images").select("*").order("is_primary",{ascending:!1});if(t)throw t;return e??[]}async function u(e){let{data:t,error:r}=await i.N.from("subcategories").select("*").eq("slug",e).maybeSingle();if(r)throw console.error("fetchSubcategoryBySlug error:",{slug:e,error:r}),r;return t}async function m(e){let{data:t,error:r}=await i.N.from("products").select("*").eq("subcategory_id",e).order("id",{ascending:!0});if(r)throw r;return t??[]}async function f(e){let{data:t,error:r}=await i.N.from("subsubcategories").select("*").eq("subcategory_id",e).order("id",{ascending:!0});return r?[]:t??[]}async function h(e){let t=Array.from(new Set(e)).filter(Boolean);if(0===t.length)return[];let{data:r,error:a}=await i.N.from("products").select("id,name,slug,long_description,category_id,subcategory_id,brand_id,is_discounted,base_price,tags,is_active").in("id",t);if(a)throw a;return r??[]}async function x(e){let t=Array.from(new Set(e)).filter(e=>null!=e);if(0===t.length)return[];let{data:r,error:a}=await i.N.from("product_variants").select("id,product_id,label,price,stock").in("id",t);if(a)throw a;return r??[]}async function p(e){return h(e)}async function y(e){let t=Array.from(new Set(e)).filter(Boolean);if(0===t.length)return[];let{data:r,error:a}=await i.N.from("product_variants").select("*").in("product_id",t).order("price",{ascending:!0});if(a)throw a;return r??[]}async function g(e){let t=Array.from(new Set(e)).filter(Boolean);if(0===t.length)return[];let{data:r,error:a}=await i.N.from("product_images").select("*").in("product_id",t).order("is_primary",{ascending:!1});if(a)throw a;return r??[]}async function N(e){let t=e.trim();if(!t)return[];let{data:r,error:a}=await i.N.from("customers").select("id,name,phone").or(`name.ilike.%${t}%,phone.ilike.%${t}%`).limit(8);if(a)throw a;return r??[]}async function b(e){let{data:t,error:r}=await i.N.from("orders").insert({customer_id:e.customer_id,delivery_name:e.delivery.name,delivery_phone:e.delivery.phone,delivery_address:e.delivery.address,delivery_note:e.delivery.note??null,total_amount:e.total_amount,status:"PENDING"}).select("id").single();if(r)throw r;return t}async function v(e,t){let r=t.map(t=>({order_id:e,product_id:t.productId,variant_id:t.variantId,quantity:t.qty,price_at_purchase:t.priceAtPurchase})),{error:a}=await i.N.from("order_items").insert(r);if(a)throw console.log("ORDER_ITEMS_INSERT_ERROR",a),a}}},e=>{e.O(0,[8500,1958,8441,3794,7358],()=>e(e.s=546)),_N_E=e.O()}]);