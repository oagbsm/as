(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[279],{117:(e,t,r)=>{"use strict";r.d(t,{N:()=>s});let s=(0,r(1958).UU)("https://ecfxrmhrfjqdmqewzrfz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjZnhybWhyZmpxZG1xZXd6cmZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDA0OTgsImV4cCI6MjA4MTkxNjQ5OH0.jtF3Qp9N7rH-KCWEMHU0atH7h-LQEJBKYO9Q2HdxkX0")},2082:(e,t,r)=>{Promise.resolve().then(r.bind(r,8120))},7270:(e,t,r)=>{"use strict";r.d(t,{Cd:()=>h,HZ:()=>w,J:()=>m,TW:()=>g,Tl:()=>f,VR:()=>i,Xo:()=>c,cg:()=>N,dC:()=>u,eN:()=>o,fS:()=>b,hB:()=>d,iV:()=>n,ii:()=>l,lN:()=>a,lv:()=>y,ob:()=>p,wR:()=>x});var s=r(117);function a(e){let t=String(e??"").trim();return t&&(t.startsWith("/")||t.startsWith("http://")||t.startsWith("https://"))?t:"/example.png"}async function i(){let{data:e,error:t}=await s.N.from("categories").select("id,slug,img,name_so,name_en").order("id",{ascending:!0});if(t)throw t;let{data:r,error:a}=await s.N.from("subcategories").select("id,category_id,slug,img,name_so,name_en").order("id",{ascending:!0});if(a)throw a;let i=r??[];return(e??[]).map(e=>({...e,subcats:i.filter(t=>t.category_id===e.id)}))}async function n(){let{data:e,error:t}=await s.N.from("categories").select("*").order("id");if(t)throw t;return e??[]}async function l(){let{data:e,error:t}=await s.N.from("subcategories").select("*").order("id");if(t)throw t;return e??[]}async function o(){let{data:e,error:t}=await s.N.from("products").select("*").order("id");if(t)throw t;return e??[]}async function c(){let{data:e,error:t}=await s.N.from("product_variants").select("*").order("id");if(t)throw t;return e??[]}async function d(){let{data:e,error:t}=await s.N.from("product_images").select("*").order("is_primary",{ascending:!1});if(t)throw t;return e??[]}async function u(e){let{data:t,error:r}=await s.N.from("subcategories").select("*").eq("slug",e).maybeSingle();if(r)throw console.error("fetchSubcategoryBySlug error:",{slug:e,error:r}),r;return t}async function m(e){let{data:t,error:r}=await s.N.from("products").select("*").eq("subcategory_id",e).order("id",{ascending:!0});if(r)throw r;return t??[]}async function f(e){let{data:t,error:r}=await s.N.from("subsubcategories").select("*").eq("subcategory_id",e).order("id",{ascending:!0});return r?[]:t??[]}async function p(e){let t=Array.from(new Set(e)).filter(Boolean);if(0===t.length)return[];let{data:r,error:a}=await s.N.from("products").select("id,name,slug,long_description,category_id,subcategory_id,brand_id,is_discounted,base_price,tags,is_active").in("id",t);if(a)throw a;return r??[]}async function h(e){let t=Array.from(new Set(e)).filter(e=>null!=e);if(0===t.length)return[];let{data:r,error:a}=await s.N.from("product_variants").select("id,product_id,label,price,stock").in("id",t);if(a)throw a;return r??[]}async function x(e){return p(e)}async function g(e){let t=Array.from(new Set(e)).filter(Boolean);if(0===t.length)return[];let{data:r,error:a}=await s.N.from("product_variants").select("*").in("product_id",t).order("price",{ascending:!0});if(a)throw a;return r??[]}async function y(e){let t=Array.from(new Set(e)).filter(Boolean);if(0===t.length)return[];let{data:r,error:a}=await s.N.from("product_images").select("*").in("product_id",t).order("is_primary",{ascending:!1});if(a)throw a;return r??[]}async function N(e){let t=e.trim();if(!t)return[];let{data:r,error:a}=await s.N.from("customers").select("id,name,phone").or(`name.ilike.%${t}%,phone.ilike.%${t}%`).limit(8);if(a)throw a;return r??[]}async function b(e){let{data:t,error:r}=await s.N.from("orders").insert({customer_id:e.customer_id,delivery_name:e.delivery.name,delivery_phone:e.delivery.phone,delivery_address:e.delivery.address,delivery_note:e.delivery.note??null,total_amount:e.total_amount,status:"PENDING"}).select("id").single();if(r)throw r;return t}async function w(e,t){let r=t.map(t=>({order_id:e,product_id:t.productId,variant_id:t.variantId,quantity:t.qty,price_at_purchase:t.priceAtPurchase})),{error:a}=await s.N.from("order_items").insert(r);if(a)throw console.log("ORDER_ITEMS_INSERT_ERROR",a),a}},8120:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>u});var s=r(5155),a=r(8500),i=r.n(a),n=r(2115),l=r(8561),o=r(117),c=r(7270);function d(e){return new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(Number(e??0))}function u(){let{items:e,clearCart:t}=(0,l._)(),r=Array.isArray(e)?e:[],[a,u]=(0,n.useState)({}),[m,f]=(0,n.useState)({}),[p,h]=(0,n.useState)(!1),[x,g]=(0,n.useState)(!1),[y,N]=(0,n.useState)("Test Customer"),[b,w]=(0,n.useState)("0622000000"),[v,j]=(0,n.useState)("MATO, MOGADISHU"),[_,I]=(0,n.useState)("Leave at the gate (demo)."),[C,S]=(0,n.useState)(!1),[E,O]=(0,n.useState)("EVC"),[k,A]=(0,n.useState)("");(0,n.useEffect)(()=>{let e=!0;return(async()=>{let t=r.map(e=>e.productId),s=r.map(e=>e.variantId).filter(e=>null!=e);try{let[r,a]=await Promise.all([(0,c.ob)(t),(0,c.Cd)(s)]);if(!e)return;let i={};for(let e of r)i[e.id]=e;let n={};for(let e of a)n[e.id]=e;u(i),f(n)}catch(e){console.error("CHECKOUT LOAD ERROR:",e)}})(),()=>{e=!1}},[e]);let P=(0,n.useMemo)(()=>r.map(e=>{let t=a[e.productId];if(!t)return null;let r=null!=e.variantId?m[e.variantId]:null,s=Number(r?.price??t.base_price??0),i=r?.label?` (${r.label})`:"";return{key:`${e.productId}-${e.variantId??"base"}`,productId:e.productId,variantId:e.variantId??null,name:`${t.name}${i}`,qty:e.qty??1,price:s,lineTotal:s*(e.qty??1)}}).filter(Boolean),[r,a,m]),R=(0,n.useMemo)(()=>P.reduce((e,t)=>e+t.lineTotal,0),[P]),q=1.99*(R>0),T=R+q;async function D(e,t){let r=String(e??"").trim(),s=String(t??"").trim()||"Customer",a=await o.N.from("customers").select("id").eq("phone",r).maybeSingle();if(a.error)throw a.error;if(a.data?.id)return Number(a.data.id);let i=await o.N.from("customers").insert({name:s,phone:r}).select("id").single();if(i.error)throw i.error;return Number(i.data.id)}async function H(){if(0!==r.length){if(!y.trim()||!b.trim()||!v.trim())return void alert("Please fill in Name, Phone, and Address.");h(!0);try{let e=function(e){let t=[];for(let r of e){let e=Number(r);Number.isFinite(e)&&e>0&&t.push(Math.trunc(e))}return Array.from(new Set(t))}(r.map(e=>e.productId)),s=await D(b,y),a=await (0,c.fS)({customer_id:s,delivery:{name:y,phone:b,address:v,note:_},total_amount:Number.isFinite(Number(T))?Number(T):0}),i=P.map(e=>({productId:e.productId,variantId:e.variantId,qty:e.qty,priceAtPurchase:Number(e.price)}));if(await (0,c.HZ)(a.id,i),!C){let e=await o.N.from("payments").insert({order_id:a.id,method:E,amount:Number.isFinite(Number(T))?Number(T):0,status:"SUCCESS",reference:k.trim()?k.trim():null}).select("id").single();if(e.error)throw e.error;let t=await o.N.from("orders").update({status:"PAID"}).eq("id",a.id);if(t.error)throw t.error}try{if(e.length>=2){let{data:t,error:s}=await o.N.rpc("record_copurchase",{product_ids:e});if(s&&s?.code==="22P02"){let e=r.map(e=>String(e.productId)).filter(e=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e));if(e.length>=2){let r=await o.N.rpc("record_copurchase",{product_ids:Array.from(new Set(e))});t=r.data,s=r.error}}s?(console.log("record_copurchase rpcErr:",s),console.log("rpcErr.code:",s?.code),console.log("rpcErr.message:",s?.message),console.log("rpcErr.details:",s?.details),console.log("rpcErr.hint:",s?.hint)):console.log("record_copurchase OK",t)}else console.log("record_copurchase skipped (need >= 2 distinct product ids)")}catch(e){console.log("record_copurchase threw (ignored):",e)}t(),g(!0)}catch(t){console.error("PLACE ORDER ERROR:",t);let e=t?.message||t?.error?.message||t?.details||("string"==typeof t?t:null)||JSON.stringify(t,null,2);String(e).toLowerCase().includes("insufficient stock")?alert("Sorry — one of the items is out of stock. Please reduce quantity or choose another size."):alert(`Failed to place order:
${e}`)}finally{h(!1)}}}return(0,s.jsx)("main",{className:"min-h-screen bg-white text-black",children:(0,s.jsxs)("div",{className:"max-w-6xl mx-auto px-4 py-6",children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)(i(),{href:"/cart",className:"text-sm text-blue-600 hover:underline",children:"← Back to cart"}),(0,s.jsx)("h1",{className:"text-xl font-semibold mt-2",children:"Checkout"}),(0,s.jsx)("div",{className:"text-sm text-gray-600 mt-1",children:"\uD83D\uDD12 Secure"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-[1.6fr_0.9fr] gap-6",children:[(0,s.jsx)("section",{children:x?(0,s.jsxs)("div",{className:"border rounded-2xl p-8 text-center",children:[(0,s.jsx)("div",{className:"text-4xl",children:"✅"}),(0,s.jsx)("p",{className:"text-xl font-semibold mt-3",children:"Order placed"}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-2",children:"Order saved to Supabase. Co-purchase counts attempted."}),(0,s.jsxs)("div",{className:"mt-6 flex gap-3 justify-center",children:[(0,s.jsx)(i(),{href:"/",className:"px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-semibold",children:"Continue shopping"}),(0,s.jsx)(i(),{href:"/cart",className:"px-5 py-2 rounded-full border text-sm font-semibold",children:"View cart"})]})]}):(0,s.jsxs)("div",{className:"border rounded-2xl p-5",children:[(0,s.jsx)("h2",{className:"font-semibold",children:"Delivery details"}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Dummy data is prefilled for testing."}),(0,s.jsxs)("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,s.jsxs)("label",{className:"text-sm",children:["Full name",(0,s.jsx)("input",{value:y,onChange:e=>N(e.target.value),className:"mt-1 w-full border rounded-xl px-3 py-2"})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Phone number",(0,s.jsx)("input",{value:b,onChange:e=>w(e.target.value),className:"mt-1 w-full border rounded-xl px-3 py-2"})]}),(0,s.jsxs)("label",{className:"text-sm md:col-span-2",children:["Address",(0,s.jsx)("input",{value:v,onChange:e=>j(e.target.value),className:"mt-1 w-full border rounded-xl px-3 py-2"})]}),(0,s.jsxs)("label",{className:"text-sm md:col-span-2",children:["Order note (optional)",(0,s.jsx)("textarea",{value:_,onChange:e=>I(e.target.value),rows:3,className:"mt-1 w-full border rounded-xl px-3 py-2"})]})]}),(0,s.jsxs)("div",{className:"mt-4 border rounded-xl p-3",children:[(0,s.jsx)("div",{className:"text-sm font-semibold",children:"Payment"}),(0,s.jsx)("div",{className:"mt-2 flex items-center gap-3",children:(0,s.jsxs)("label",{className:"text-sm flex items-center gap-2",children:[(0,s.jsx)("input",{type:"checkbox",checked:C,onChange:e=>S(e.target.checked)}),"Credit order (mark as PENDING)"]})}),(0,s.jsxs)("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,s.jsxs)("label",{className:"text-sm",children:["Method",(0,s.jsxs)("select",{value:E,onChange:e=>O(e.target.value),className:"mt-1 w-full border rounded-xl px-3 py-2",disabled:C,children:[(0,s.jsx)("option",{value:"EVC",children:"EVC"}),(0,s.jsx)("option",{value:"MERCHANT",children:"MERCHANT"}),(0,s.jsx)("option",{value:"CASH",children:"CASH"})]})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Reference (optional)",(0,s.jsx)("input",{value:k,onChange:e=>A(e.target.value),className:"mt-1 w-full border rounded-xl px-3 py-2",placeholder:"Txn ID / note",disabled:C})]})]}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:"If Credit is checked, no payment row is created now (so you won’t get duplicate payments)."})]}),(0,s.jsx)("button",{onClick:H,disabled:p||0===r.length,className:`mt-5 w-full rounded-full py-3 text-sm font-semibold ${p||0===r.length?"bg-gray-200 text-gray-500":"bg-blue-600 text-white"}`,children:p?"Placing order…":C?`Create Credit Order • ${d(T)}`:`Pay Now • ${d(T)}`}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-3",children:"By placing an order, you help improve “bought together” recommendations."})]})}),(0,s.jsx)("aside",{children:(0,s.jsxs)("div",{className:"border rounded-2xl p-5 sticky top-20",children:[(0,s.jsx)("h2",{className:"font-semibold",children:"Order summary"}),(0,s.jsx)("div",{className:"mt-4 space-y-3",children:0===P.length?(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"No items."}):P.map(e=>(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsxs)("span",{className:"text-gray-700",children:[e.name," \xd7 ",e.qty]}),(0,s.jsx)("span",{className:"font-semibold",children:d(e.lineTotal)})]},e.key))}),(0,s.jsxs)("div",{className:"mt-4 border-t pt-4 space-y-2 text-sm",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{children:"Subtotal"}),(0,s.jsx)("span",{className:"font-semibold",children:d(R)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{children:"Delivery"}),(0,s.jsx)("span",{className:"font-semibold",children:d(q)})]}),(0,s.jsxs)("div",{className:"flex justify-between border-t pt-3",children:[(0,s.jsx)("span",{className:"font-semibold",children:"Total"}),(0,s.jsx)("span",{className:"font-semibold",children:d(T)})]})]}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-3",children:"Tip: If co-purchase RPC fails, ensure the function exists and EXECUTE is granted for anon."})]})})]})]})})}},8561:(e,t,r)=>{"use strict";r.d(t,{CartProvider:()=>n,_:()=>l});var s=r(5155),a=r(2115);let i=(0,a.createContext)(null);function n({children:e}){let[t,r]=(0,a.useState)([]);function n(e,t){r(r=>r.filter(r=>r.productId!==e||r.variantId!==t))}return(0,a.useEffect)(()=>{let e=localStorage.getItem("cart");e&&r(JSON.parse(e))},[]),(0,a.useEffect)(()=>{localStorage.setItem("cart",JSON.stringify(t))},[t]),(0,s.jsx)(i.Provider,{value:{items:t,addItem:function(e,t,s=1){r(r=>r.find(r=>r.productId===e&&r.variantId===t)?r.map(r=>r.productId===e&&r.variantId===t?{...r,qty:r.qty+s}:r):[...r,{productId:e,variantId:t,qty:s}])},setQty:function(e,t,s){s<=0?n(e,t):r(r=>r.map(r=>r.productId===e&&r.variantId===t?{...r,qty:s}:r))},removeItem:n,clearCart:function(){r([])}},children:e})}function l(){let e=(0,a.useContext)(i);if(!e)throw Error("useCart must be used inside CartProvider");return e}}},e=>{e.O(0,[500,958,441,794,358],()=>e(e.s=2082)),_N_E=e.O()}]);